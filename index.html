<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó≥Ô∏è Campagne √âlectorale Consulaires 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active {
            background-color: #3b82f6;
            color: white;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .controlled-message {
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: 500;
            padding: 4px 8px;
            font-size: 0.75rem;
            background-color: #fef2f2;
            border: 1px solid #f87171;
            color: #b91c1c;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 20;
            white-space: nowrap;
        }
        /* Custom scrollbar for contact list */
        .contact-list-container {
            overflow-y: auto;
        }
        .contact-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .contact-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .contact-list-container::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 4px;
        }
        .contact-list-container::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* Splash Screen specific styles */
        .splash-logo {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1d4ed8; /* Blue-700 */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .splash-logo-sub {
            font-size: 1.5rem;
            color: #3b82f6; /* Blue-500 */
        }
    </style>
</head>
<body>

    <!-- Splash Screen / Team Login View -->
    <div id="login-splash-view" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100">
        <div class="text-center mb-10">
            <p class="splash-logo">Nouvelle √ânergie</p>
            <p class="splash-logo-sub">Campagne Consulaires 2026</p>
        </div>
        
        <div id="splash-login-card" class="w-full max-w-md bg-white shadow-xl rounded-lg p-8 space-y-6">
            <h2 class="text-2xl font-bold text-center text-gray-800">Connexion √âquipe</h2>
            
            <!-- Bootstrap Panel (Visible by default in HTML, hidden by JS if members are found) -->
            <div id="splash-bootstrap-panel" class="p-4 bg-gray-50 border-2 border-blue-200 border-dashed rounded-lg">
                <h3 class="text-md font-bold text-gray-800 mb-2">Mode D√©marrage (Base de donn√©es vide)</h3>
                <p class="text-sm text-gray-600 mb-3">Cr√©ez le premier compte. Entrez **Damien** pour obtenir les droits **Administrateur**.</p>
                <div>
                    <label for="bootstrap-member-name" class="block text-sm font-medium text-gray-700">Nom du Premier Membre</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="bootstrap-member-name" placeholder="Ex: Damien" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md sm:text-sm border-gray-300 px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <button id="bootstrap-add-member-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-blue-600 text-white text-sm hover:bg-blue-700">Cr√©er & Se Connecter</button>
                    </div>
                    <p id="bootstrap-error-message" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>
            </div>

            <!-- Default Login Form (Hidden by default in HTML, revealed by JS if members are found) -->
            <div id="splash-login-form" class="space-y-4 hidden">
                <div>
                    <label for="splash-login-member-select" class="block text-sm font-medium text-gray-700">S√©lectionner votre nom</label>
                    <select id="splash-login-member-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">-- Chargement des membres... --</option>
                    </select>
                </div>
                <div class="relative">
                    <label for="splash-auth-key-input" class="block text-sm font-medium text-gray-700">Cl√© de Connexion Secr√®te</label>
                    <input type="password" id="splash-auth-key-input" placeholder="Entrez la cl√©..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p id="splash-login-error-message" class="text-red-500 text-xs mt-1 hidden">Nom ou cl√© incorrect(e).</p>
                </div>
                <button id="splash-team-login-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Se Connecter</button>
            </div>

            <!-- Placeholder for critical errors -->
            <div id="critical-error-message" class="text-red-600 text-center text-sm hidden"></div>
        </div>
    </div>


    <!-- Main Application Container (Hidden until logged in) -->
    <div id="app-container" class="min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Campagne √âlectorale Consulaires 2026</h1>
                <div id="user-info" class="text-sm text-gray-500 flex items-center space-x-4">
                    <span class="font-medium text-gray-700">Connect√©:</span> <span id="user-id" class="break-all font-semibold text-gray-900">Non Connect√©</span>
                    <span id="team-member-status" class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 hidden"></span>
                    <button id="team-logout-btn" class="inline-flex justify-center py-1 px-3 border border-transparent shadow-sm text-xs font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">D√©connexion</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-gray-800 text-white" id="main-nav">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-center h-16">
                    <div class="flex items-baseline space-x-4">
                        <!-- Dashboard and Projections hidden for non-admins -->
                        <a href="#" id="nav-dashboard" data-view="dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium hidden">Tableau de Bord</a>
                        <a href="#" id="nav-contacts" data-view="contacts" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Gestion des Contacts</a>
                        <a href="#" id="nav-team" data-view="team" class="nav-link px-3 py-2 rounded-md text-sm font-medium">√âquipe</a>
                        <a href="#" id="nav-projections" data-view="projections" class="nav-link px-3 py-2 rounded-md text-sm font-medium hidden">Projections</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                
                <!-- Loading Indicator (Only shown briefly during Firebase auth) -->
                <div id="loading-indicator" class="text-center p-8 text-lg font-medium text-blue-600 hidden">
                    Connexion aux services de donn√©es...
                </div>

                <!-- Dashboard View -->
                <div id="dashboard-view" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">Contacts G√©r√©s</h3><p id="kpi-total-contacts" class="text-3xl font-bold text-gray-900">0</p></div>
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">Votes "Certains"</h3><p id="kpi-certain-votes" class="text-3xl font-bold text-blue-600">0</p></div>
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">A Vot√© (Jour J)</h3><p id="kpi-has-voted" class="text-3xl font-bold text-violet-600">0</p></div>
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">Votes Projet√©s (pond√©r√©s)</h3><p id="kpi-projected-votes" class="text-3xl font-bold text-green-600">0</p></div>
                    </div>

                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <h3 id="goal-title" class="text-lg font-medium text-gray-900 mb-2">Objectif de 1000 votes certains</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="goal-progress-bar" class="bg-blue-600 h-4 rounded-full text-center text-white text-xs" style="width: 0%;"></div>
                        </div>
                        <p id="goal-progress-text" class="text-right text-sm text-gray-600 mt-1">0 / 1000</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">R√©partition des Contacts</h3>
                            <canvas id="status-chart"></canvas>
                        </div>
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Anniversaires √† venir (30 jours)</h3>
                            <div id="birthday-list" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500">Aucun anniversaire dans les 30 prochains jours.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacts View -->
                <div id="contacts-view" class="hidden">
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                             <div>
                                <h2 class="text-xl font-bold text-gray-800">Gestion G√©n√©rale des Contacts</h2>
                                <p class="text-sm text-gray-500">Importez, recherchez et assignez des contacts √† votre √©quipe.</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="csv-file-input" class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Importer un CSV
                                    <input id="csv-file-input" type="file" accept=".csv" class="hidden">
                                </label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="search-contacts" placeholder="Rechercher par nom, pr√©nom, email..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="contact-list-container overflow-x-auto max-h-[60vh] relative">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√©nom(s)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√©l√©phone</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsable</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="contacts-table-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Team View -->
                <div id="team-view" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- Col 1: Team Management & Login -->
                        <div class="lg:col-span-1 bg-white shadow rounded-lg p-6 space-y-6">
                            
                            <!-- Team Member Login (Simplified: connection is now via splash screen) -->
                            <div class="border-b pb-4 mb-4">
                                <h2 class="text-xl font-bold text-blue-600 mb-4">Statut de Connexion</h2>
                                <p id="current-member-info" class="text-lg font-semibold text-gray-700"></p>
                                <p id="is-admin-info" class="text-sm mt-1 text-green-600 font-medium hidden">ACC√àS ADMINISTRATEUR</p>
                            </div>

                            <!-- Admin: Add Team Member -->
                            <div id="admin-member-creation-panel" class="hidden">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Ajouter un Membre (Admin)</h2>
                                <p class="text-sm text-gray-500 mb-4">Une cl√© d'authentification unique sera g√©n√©r√©e. (Damien = Admin)</p>
                                <div>
                                    <label for="new-team-member" class="block text-sm font-medium text-gray-700">Nom du membre</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="new-team-member" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md sm:text-sm border-gray-300 px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                        <button id="add-team-member-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm hover:bg-gray-100">
                                            Ajouter
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Admin: Team List & Keys -->
                            <div id="admin-team-list-panel" class="hidden">
                                <h3 class="text-lg font-medium text-gray-700 mt-6">Liste des Membres et Cl√©s</h3>
                                <div id="team-list" class="space-y-2 pt-2 text-xs">
                                    <!-- List of team members with keys and delete button -->
                                </div>
                            </div>
                        </div>

                        <!-- Col 2/3: Contacts Assigned -->
                        <div class="lg:col-span-2 bg-white shadow rounded-lg p-6">
                            <div id="team-member-contact-view">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Contacts Assign√©s</h2>
                                <p class="text-sm text-gray-500">Visualisation et mise √† jour de votre portefeuille de contacts.</p>
                                
                                <!-- Admin Selector (Optional - for admin to view others' lists) -->
                                <div id="admin-view-selector" class="mt-4 mb-4 p-3 bg-gray-50 rounded-lg border hidden">
                                    <label for="admin-team-member-select" class="block text-xs font-medium text-gray-700">Vue Admin: Voir la liste de</label>
                                    <select id="admin-team-member-select" class="mt-1 block w-full pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                        <option value="">-- S√©lectionner un membre --</option>
                                    </select>
                                </div>


                                <p id="team-contact-placeholder" class="text-gray-500 mt-6">Veuillez vous connecter pour voir votre liste de contacts.</p>
                                <div id="team-contact-list-container" class="hidden contact-list-container overflow-x-auto max-h-[60vh] relative">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nom</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pr√©nom(s)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">T√©l√©phone (Contr√¥le)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut (Campagne)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">A Vot√© (Jour J)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="team-contacts-table-body" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projections View -->
                <div id="projections-view" class="hidden">
                     <div class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1 bg-white shadow rounded-lg p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Param√®tres de la Simulation</h2>
                                <div class="space-y-6">
                                    <div>
                                        <label for="total-inscrits" class="block text-sm font-medium text-gray-700">Nombre total d'inscrits (LEC)</label>
                                        <input type="number" id="total-inscrits" value="18000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="turnout" class="block text-sm font-medium text-gray-700">Taux de participation estim√© (%)</label>
                                        <input type="number" id="turnout" value="25" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="num-lists" class="block text-sm font-medium text-gray-700">Nombre de listes en comp√©tition</label>
                                        <input type="number" id="num-lists" value="4" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="objective-seats" class="block text-sm font-medium text-gray-700">Nombre de si√®ges vis√©s (Objectif)</label>
                                        <input type="number" id="objective-seats" value="1" min="1" max="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <button id="run-projection" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Lancer la Projection</button>
                                </div>
                            </div>
                            <div class="lg:col-span-2 bg-white shadow rounded-lg p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">R√©sultats de la Projection</h2>
                                <div id="projection-results" class="space-y-4">
                                   <p class="text-gray-500">Veuillez configurer les param√®tres et lancer la projection pour voir les r√©sultats.</p>
                                </div>
                                <div id="projection-summary-table" class="mt-6"></div>
                            </div>
                        </div>
                        <div class="bg-white shadow rounded-lg p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">√âvolution de la Campagne</h2>
                            <canvas id="history-chart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Chart.js for the doughnut chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE IMPORTS (truncated part completed for valid HTML structure) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, setDoc, query, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set Firebase Log Level to debug for development/testing
        setLogLevel('Debug');

        // --- GLOBAL FIREBASE/APP VARIABLES ---
        let db;
        let auth;
        let userId = 'anonymous'; // Default until authenticated
        
        // *******************************************************************
        // CONFIGURATION FIREBASE - LOGIQUE DE CHARGEMENT ROBUSTE
        // *******************************************************************
        
        // Configuration de secours (fall-back) avec les valeurs fournies
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyBy_3k0dPsPCN5b_iOfZl22eJoq8BWbaRo",
            authDomain: "elecmanager-6f50a.firebaseapp.com",
            projectId: "elecmanager-6f50a",
            storageBucket: "elecmanager-6f50a.firebasestorage.app",
            messagingSenderId: "872950170067",
            appId: "1:872950170067:web:dc23cc105538d3e88baf26",
            measurementId: "G-GXP88CTD96"
        };
        const hardcodedAppId = hardcodedFirebaseConfig.appId;

        let configSource = hardcodedFirebaseConfig;
        
        // Tentative de r√©cup√©ration des variables de l'environnement Gemini
        const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedAppId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        if (typeof __firebase_config !== 'undefined' && __firebase_config.length > 0) {
            try {
                const parsedConfig = JSON.parse(__firebase_config);
                if (parsedConfig && parsedConfig.projectId) {
                    configSource = parsedConfig; // Utiliser la config inject√©e si disponible
                }
            } catch (e) {
                console.warn("Firebase: Parsing de __firebase_config √©chou√©. Utilisation de la configuration de repli.");
            }
        } 
        
        const firebaseConfig = configSource;

        // --- GLOBAL STATE ---
        window.contacts = [];
        window.teamMembers = [];
        window.projectionHistory = [];
        window.votesGoal = 1000;
        window.isAuthReady = false; // Flag to ensure listeners start only after auth
        window.currentTeamMemberId = null; // State for logged-in team member
        window.currentTeamMemberName = null;
        window.isAdmin = false; // New state for role-based access control
        let historyChartInstance = null; // Instance for the evolution chart
        let statusChartInstance = null;

        const STATUS_OPTIONS = {
            '√Ä contacter': '√Ä contacter', '√Ä convaincre': '√Ä convaincre', 'Probable': 'Probable',
            'Acquis': 'Acquis', 'Refus': 'Refus', 'A vot√©': 'A vot√©'
        };

        const STATUS_COLORS = {
            '√Ä contacter': '#9ca3af', '√Ä convaincre': '#f59e0b', 'Probable': '#84cc16',
            'Acquis': '#2563eb', 'Refus': '#ef4444', 'A vot√©': '#8b5cf6'
        };
        
        const TEAM_STATUS_OPTIONS = {
            '√Ä contacter': '√Ä contacter', '√Ä convaincre': '√Ä convaincre', 'Probable': 'Probable',
            'Acquis': 'Acquis', 'Refus': 'Refus'
        };
        
        // --- DOM Elements ---
        const $ = id => document.getElementById(id);
        const views = ['dashboard', 'contacts', 'team', 'projections'];


        // --- FIRESTORE UTILS ---
        // Public collection path for collaborative team data
        function getPublicCollectionRef(collectionName) {
            if (db) {
                return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
            }
            console.error("Firestore DB is not initialized.");
            return null;
        }
        
        // Private collection for user-specific data (e.g., projection history)
        function getPrivateCollectionRef(collectionName) {
            if (db) {
                return collection(db, 'artifacts', appId, 'users', userId, collectionName);
            }
            console.error("Firestore DB is not initialized.");
            return null;
        }

        // --- AUTH & MEMBER MANAGEMENT UTILS ---
        function generateSecretKey(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function setCurrentUser(member) {
            window.currentTeamMemberId = member.id;
            window.currentTeamMemberName = member.name;
            window.isAdmin = member.isAdmin || false;
            
            // Masquer la vue de connexion et afficher la vue principale
            $('login-splash-view').classList.add('hidden');
            $('app-container').classList.remove('hidden');

            // Mise √† jour de l'affichage de l'utilisateur
            $('user-id').textContent = member.name;
            const statusEl = $('team-member-status');
            statusEl.textContent = member.isAdmin ? 'Admin' : 'Membre';
            statusEl.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800');
            statusEl.classList.add(member.isAdmin ? 'bg-red-100' : 'bg-blue-100', member.isAdmin ? 'text-red-800' : 'text-blue-800');
            $('current-member-info').textContent = `Connect√© en tant que: ${member.name}`;

            // Afficher les vues admin/cacher pour les non-admins
            $('nav-dashboard').classList.toggle('hidden', !window.isAdmin);
            $('nav-projections').classList.toggle('hidden', !window.isAdmin);
            $('admin-member-creation-panel').classList.toggle('hidden', !window.isAdmin);
            $('admin-team-list-panel').classList.toggle('hidden', !window.isAdmin);
            $('admin-view-selector').classList.toggle('hidden', !window.isAdmin);


            setupPrivateDataListeners(); // D√©marrer l'√©coute des donn√©es priv√©es de ce membre
            switchView('team'); // Afficher la vue √©quipe par d√©faut apr√®s connexion
        }

        function handleLogout() {
            window.currentTeamMemberId = null;
            window.currentTeamMemberName = null;
            window.isAdmin = false;
            $('app-container').classList.add('hidden');
            $('login-splash-view').classList.remove('hidden');
            window.updateLoginSelect(); // R√©initialiser le s√©lecteur de connexion
            showMessageBox('D√©connexion', 'Vous √™tes d√©connect√© de l\'√©quipe.', 'info');
        }

        // --- VIEW CONTROLS ---

        function switchView(viewName) {
            views.forEach(view => {
                $(`${view}-view`).classList.add('hidden');
                $(`nav-${view}`).classList.remove('active');
            });
            
            $(`${viewName}-view`).classList.remove('hidden');
            $(`nav-${viewName}`).classList.add('active');

            if (viewName === 'team') {
                updateTeamView();
            } else if (viewName === 'dashboard') {
                updateDashboardView();
            }
            // Ajoutez d'autres mises √† jour de vue ici
        }

        function updateLoginSelect() {
            const selectEl = $('splash-login-member-select');
            selectEl.innerHTML = '';

            if (window.teamMembers.length === 0) {
                // Si la liste est vide, on affiche le panneau de bootstrap
                $('splash-bootstrap-panel').classList.remove('hidden');
                $('splash-login-form').classList.add('hidden');
            } else {
                // Si des membres existent, on affiche le formulaire de connexion
                $('splash-bootstrap-panel').classList.add('hidden');
                $('splash-login-form').classList.remove('hidden');
                
                // Remplir le s√©lecteur
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "-- S√©lectionnez votre nom --";
                selectEl.appendChild(defaultOption);

                window.teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    selectEl.appendChild(option);
                });
            }

            // Mettre √† jour le s√©lecteur admin pour la vue Team
            const adminSelect = $('admin-team-member-select');
            adminSelect.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'TOUS LES CONTACTS (Admin)';
            adminSelect.appendChild(allOption);
            window.teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                adminSelect.appendChild(option);
            });
        }


        // --- CRUD LOGIC ---

        async function handleBootstrapClick() {
            const nameInput = $('bootstrap-member-name');
            const name = nameInput.value.trim();
            const errorEl = $('bootstrap-error-message');
            errorEl.classList.add('hidden');

            if (name === "") {
                errorEl.textContent = "Veuillez entrer un nom.";
                errorEl.classList.remove('hidden');
                return;
            }

            const isDamien = name.toLowerCase() === 'damien';
            const authKey = generateSecretKey(10);
            
            const memberData = {
                name: name,
                authKey: authKey, // Cl√© de connexion pour la session suivante
                isAdmin: isDamien,
                createdAt: serverTimestamp()
            };

            try {
                const teamMembersRef = getPublicCollectionRef('teamMembers');
                const docRef = await addDoc(teamMembersRef, memberData);
                
                // Succ√®s : Simuler la connexion avec le nouveau membre
                const newMember = { ...memberData, id: docRef.id };

                // Afficher la cl√© de connexion pour la premi√®re fois
                showMessageBox('Connexion r√©ussie', 
                    `Le membre "${name}" a √©t√© cr√©√©. C'est votre CL√â SECR√àTE de connexion: 
                     <span class="font-mono text-lg text-blue-800">${authKey}</span>. 
                     Conservez-la pour les prochaines connexions.`, 'success', true);
                
                setCurrentUser(newMember);

            } catch (error) {
                console.error("Erreur Firestore lors du bootstrap:", error);
                errorEl.textContent = "Erreur lors de la cr√©ation du membre dans la base de donn√©es. " + error.message;
                errorEl.classList.remove('hidden');
            }
        }

        async function handleTeamLogin() {
            const selectEl = $('splash-login-member-select');
            const keyInput = $('splash-auth-key-input');
            const errorEl = $('splash-login-error-message');
            errorEl.classList.add('hidden');

            const memberId = selectEl.value;
            const key = keyInput.value.trim();

            if (!memberId || key === "") {
                errorEl.textContent = "Veuillez s√©lectionner un nom et entrer la cl√©.";
                errorEl.classList.remove('hidden');
                return;
            }

            const member = window.teamMembers.find(m => m.id === memberId && m.authKey === key);

            if (member) {
                setCurrentUser(member);
                keyInput.value = ''; // Clear key
            } else {
                errorEl.textContent = "Cl√© de connexion incorrecte pour ce membre.";
                errorEl.classList.remove('hidden');
            }
        }
        
        async function handleAddTeamMember() {
            const nameInput = $('new-team-member');
            const name = nameInput.value.trim();

            if (!window.isAdmin || name === "") return;

            const isDamien = name.toLowerCase() === 'damien';
            const authKey = generateSecretKey(10);
            
            const memberData = {
                name: name,
                authKey: authKey,
                isAdmin: isDamien,
                createdAt: serverTimestamp()
            };

            try {
                const teamMembersRef = getPublicCollectionRef('teamMembers');
                await addDoc(teamMembersRef, memberData);
                nameInput.value = '';
                showMessageBox('Membre Ajout√©', `"${name}" a √©t√© ajout√©. Cl√©: ${authKey}`, 'success');
            } catch (error) {
                console.error("Erreur d'ajout de membre:", error);
                showMessageBox('Erreur', "√âchec de l'ajout du membre.", 'error');
            }
        }

        async function handleDeleteTeamMember(memberId) {
            if (!window.isAdmin) return;

            // Protection: emp√™cher un admin de se supprimer lui-m√™me (trop risqu√©)
            if (memberId === window.currentTeamMemberId) {
                showMessageBox('Interdit', "Vous ne pouvez pas vous supprimer vous-m√™me.", 'error');
                return;
            }

            try {
                const teamMembersRef = getPublicCollectionRef('teamMembers');
                await deleteDoc(doc(teamMembersRef, memberId));
            } catch (error) {
                console.error("Erreur de suppression de membre:", error);
                showMessageBox('Erreur', "√âchec de la suppression du membre.", 'error');
            }
        }
        
        // --- DISPLAY LOGIC ---

        function updateTeamView() {
            if (!window.currentTeamMemberId) {
                $('team-contact-placeholder').classList.remove('hidden');
                $('team-contact-list-container').classList.add('hidden');
                return;
            }

            // 1. Affichage de la liste d'√©quipe (Admin)
            if (window.isAdmin) {
                const teamListEl = $('team-list');
                teamListEl.innerHTML = '';
                window.teamMembers.forEach(member => {
                    const el = document.createElement('div');
                    el.className = 'p-2 bg-gray-50 border rounded-md flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${member.name}</span> 
                            <span class="text-gray-500 text-xs">(${member.isAdmin ? 'ADMIN' : 'Membre'})</span><br>
                            <span class="font-mono text-blue-600 text-[10px] break-all">Cl√©: ${member.authKey}</span>
                        </div>
                        <button class="delete-member-btn px-2 py-1 text-xs bg-red-100 text-red-700 rounded-full hover:bg-red-200" data-member-id="${member.id}">
                            Supprimer
                        </button>
                    `;
                    teamListEl.appendChild(el);
                });
                // Ajouter les √©couteurs pour les boutons de suppression
                teamListEl.querySelectorAll('.delete-member-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const memberId = e.currentTarget.dataset.memberId;
                        if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${window.teamMembers.find(m => m.id === memberId)?.name} ?`)) {
                             handleDeleteTeamMember(memberId);
                        } else {
                            // On utilise un message box pour les "alertes"
                            showMessageBox('Action Annul√©e', "La suppression du membre a √©t√© annul√©e.", 'info');
                        }
                    });
                });
            }


            // 2. Affichage des contacts assign√©s (TODO: Filter contacts by current user in a future iteration)
            $('team-contact-placeholder').classList.add('hidden');
            $('team-contact-list-container').classList.remove('hidden');
            
            // Pour l'instant, on affiche tous les contacts pour le test
            const teamContactsBody = $('team-contacts-table-body');
            teamContactsBody.innerHTML = '';

            const filteredContacts = window.contacts.filter(c => c.assignedTo === window.currentTeamMemberName || window.isAdmin);
            
            if (filteredContacts.length === 0) {
                 teamContactsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Aucun contact assign√©.</td></tr>`;
            } else {
                 // Remplir le tableau des contacts (simplifi√© pour cet exemple)
                 filteredContacts.slice(0, 10).forEach(contact => { // Afficher max 10 pour l'exemple
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${contact.lastName || 'N/A'}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${contact.firstName || 'N/A'}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${contact.phone || 'N/A'}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color: ${STATUS_COLORS[contact.status] || '#e5e7eb'}; color: ${contact.status === '√Ä contacter' ? '#1f2937' : 'white'};">
                                ${contact.status || 'N/A'}
                            </span>
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-center">${contact.hasVoted ? '‚úÖ' : '‚ùå'}</td>
                    `;
                    teamContactsBody.appendChild(row);
                });
            }
        }
        
        function updateDashboardView() {
            if (!window.isAdmin) return;
            
            const totalContacts = window.contacts.length;
            const certainVotes = window.contacts.filter(c => c.status === 'Acquis').length;
            const hasVoted = window.contacts.filter(c => c.hasVoted).length;

            $('kpi-total-contacts').textContent = totalContacts;
            $('kpi-certain-votes').textContent = certainVotes;
            $('kpi-has-voted').textContent = hasVoted;

            const progress = totalContacts > 0 ? Math.min(100, (certainVotes / window.votesGoal) * 100) : 0;
            $('goal-progress-bar').style.width = `${progress}%`;
            $('goal-progress-text').textContent = `${certainVotes} / ${window.votesGoal}`;
            $('goal-title').textContent = `Objectif de ${window.votesGoal} votes certains`;
            
            // Calcul des votes projet√©s (Simplifi√©: certain + probable * 0.5)
            const probableVotes = window.contacts.filter(c => c.status === 'Probable').length;
            const projectedVotes = Math.round(certainVotes + (probableVotes * 0.5));
            $('kpi-projected-votes').textContent = projectedVotes;
            
            updateStatusChart();
        }

        function updateStatusChart() {
            if (!window.isAdmin) return;

            const statusCounts = Object.keys(STATUS_OPTIONS).reduce((acc, key) => ({ ...acc, [key]: 0 }), {});
            window.contacts.forEach(c => {
                if (statusCounts.hasOwnProperty(c.status)) {
                    statusCounts[c.status]++;
                }
            });

            const data = {
                labels: Object.keys(statusCounts),
                datasets: [{
                    label: 'R√©partition des Contacts',
                    data: Object.values(statusCounts),
                    backgroundColor: Object.values(STATUS_COLORS),
                    hoverOffset: 4
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { enabled: true }
                    }
                }
            };

            if (statusChartInstance) {
                statusChartInstance.data = data;
                statusChartInstance.update();
            } else {
                statusChartInstance = new Chart($('status-chart'), config);
            }
        }

        function updateAll() {
            // Mise √† jour de la vue de connexion/bootstrap
            updateLoginSelect();
            
            // Si l'utilisateur est connect√©, mettre √† jour toutes les vues pertinentes
            if (window.currentTeamMemberId) {
                updateTeamView();
                updateDashboardView();
            }
        }
        window.updateAll = updateAll; // Rendre la fonction accessible globalement pour les listeners
        window.updateLoginSelect = updateLoginSelect;
        
        // Fonction utilitaire pour remplacer alert()
        function showMessageBox(title, message, type, isHtml = false) {
            const container = document.body;
            const box = document.createElement('div');
            box.className = `fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50`;
            
            let color, icon;
            if (type === 'error') {
                color = 'bg-red-100 border-red-400 text-red-700';
                icon = '‚ùå';
            } else if (type === 'success') {
                color = 'bg-green-100 border-green-400 text-green-700';
                icon = '‚úÖ';
            } else {
                color = 'bg-blue-100 border-blue-400 text-blue-700';
                icon = '‚ÑπÔ∏è';
            }
            
            box.innerHTML = `
                <div class="${color} border-l-4 p-6 rounded-xl shadow-2xl max-w-md relative">
                    <p class="font-bold text-xl mb-2">${icon} ${title}</p>
                    <div class="mt-1 text-sm">${isHtml ? message : message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                    <button class="mt-4 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" onclick="this.closest('.fixed').remove()">
                        Compris
                    </button>
                </div>
            `;
            container.appendChild(box);
        }

        // --- FIREBASE INITIALIZATION & AUTH ---
        async function initializeFirebase() {
            console.log("Configuration Firebase finale utilis√©e:", firebaseConfig);

            // V√©rification critique
            if (!firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                const errorMsg = "Erreur critique: apiKey, authDomain, ou projectId manquant. V√©rifiez vos variables.";
                console.error(errorMsg);
                $('critical-error-message').textContent = errorMsg;
                $('critical-error-message').classList.remove('hidden');
                $('splash-login-card').classList.add('hidden');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                
                // 1. Authentification
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID(); 
                window.isAuthReady = true;

                // 2. D√©marrer l'√©coute des donn√©es publiques
                loadPublicData();
                
                $('loading-indicator').classList.add('hidden');
                $('user-id').textContent = userId.substring(0, 8) + '...';

                // 3. √âcouteur de l'√©tat d'authentification (pour associer le membre)
                onAuthStateChanged(auth, (user) => {
                    if (user && window.isAuthReady) {
                        // L'utilisateur Firebase est connect√©. Nous devons maintenant le lier √† un membre de l'√©quipe (TeamMember)
                        
                        // Si l'utilisateur est d√©j√† connect√© en tant que membre d'√©quipe, on ne fait rien
                        if (window.currentTeamMemberId) return;

                        // Tenter de retrouver le membre d'√©quipe associ√© au userId (Non impl√©ment√© ici, car la connexion passe par le splash screen)
                        // Dans cette version, nous faisons confiance au splash screen pour d√©finir currentTeamMemberId
                    }
                });

                // 4. Ajouter des donn√©es de contact fictives si la base est vide (pour le test)
                if (window.contacts.length === 0 && window.teamMembers.length > 0) {
                     // Logique de remplissage non incluse pour garder l'initialisation propre.
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                $('critical-error-message').textContent = "Erreur de connexion Firebase: " + error.message;
                $('critical-error-message').classList.remove('hidden');
            }
        }

        // --- FIRESTORE LISTENERS (Real-time updates) ---
        function loadPublicData() {
            if (!db) return;
            
            // 1. Listen for Team Members (Public/Shared data)
            const teamMembersRef = getPublicCollectionRef('teamMembers');
            if (teamMembersRef) {
                onSnapshot(teamMembersRef, (snapshot) => {
                    window.teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Tentative de reconnexion automatique si un ID de membre est stock√© (pas impl√©ment√© ici, on se fie au splash)
                    window.updateAll();
                }, (error) => console.error("Error fetching team members:", error));
            }
            
            // 2. Listen for Contacts (Public/Shared data)
            const contactsRef = getPublicCollectionRef('contacts');
            if (contactsRef) {
                onSnapshot(contactsRef, (snapshot) => {
                    window.contacts = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(), 
                        hasVoted: doc.data().hasVoted || false // S'assurer que hasVoted existe
                    }));
                    window.updateAll();
                }, (error) => console.error("Error fetching contacts:", error));
            }
        }

        function setupPrivateDataListeners() {
            if (!db || !window.isAuthReady) return;
            
            // 3. Listen for Projection History (User-specific private data)
            const historyRef = getPrivateCollectionRef('projectionHistory');
            if (historyRef) {
                onSnapshot(historyRef, (snapshot) => {
                    window.projectionHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.timestamp - b.timestamp);
                    
                    const lastHistory = window.projectionHistory[window.projectionHistory.length - 1];
                    if (lastHistory && lastHistory.goal) {
                        window.votesGoal = lastHistory.goal;
                    }
                    window.updateAll();
                }, (error) => console.error("Error fetching history:", error));
            }
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('#main-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.currentTarget.dataset.view);
                });
            });

            // Splash Screen buttons
            $('bootstrap-add-member-btn').addEventListener('click', handleBootstrapClick);
            $('splash-team-login-btn').addEventListener('click', handleTeamLogin);
            
            // Main App buttons
            $('team-logout-btn').addEventListener('click', handleLogout);
            $('add-team-member-btn').addEventListener('click', handleAddTeamMember);
            
            // Set initial active view (Team view is the default landing after login)
            const defaultView = window.isAdmin ? 'dashboard' : 'contacts';
            views.forEach(view => $(`nav-${view}`).classList.remove('active'));
            $(`nav-team`).classList.add('active'); // Default selected tab
        }


        window.onload = () => {
            initializeFirebase(); // D√©marre la connexion Firebase et l'√©coute des donn√©es publiques
            setupEventListeners(); // Configure les gestionnaires d'√©v√©nements
        };
    </script>
</body>
</html>
