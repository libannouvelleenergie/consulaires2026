<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó≥Ô∏è Campagne √âlectorale Consulaires 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active {
            background-color: #3b82f6;
            color: white;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .controlled-message {
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: 500;
            padding: 4px 8px;
            font-size: 0.75rem;
            background-color: #fef2f2;
            border: 1px solid #f87171;
            color: #b91c1c;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 20;
            white-space: nowrap;
        }
        /* Custom scrollbar for contact list */
        .contact-list-container {
            overflow-y: auto;
        }
        .contact-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .contact-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .contact-list-container::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 4px;
        }
        .contact-list-container::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* Splash Screen specific styles */
        .splash-logo {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1d4ed8; /* Blue-700 */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .splash-logo-sub {
            font-size: 1.5rem;
            color: #3b82f6; /* Blue-500 */
        }
    </style>
</head>
<body>

    <!-- Splash Screen / Team Login View -->
    <div id="login-splash-view" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100">
        <div class="text-center mb-10">
            <p class="splash-logo">Nouvelle √ânergie</p>
            <p class="splash-logo-sub">Campagne Consulaires 2026</p>
        </div>
        
        <div id="splash-login-card" class="w-full max-w-md bg-white shadow-xl rounded-lg p-8 space-y-6">
            <h2 class="text-2xl font-bold text-center text-gray-800">Connexion √âquipe</h2>
            
            <div id="splash-login-form" class="space-y-4">
                <div>
                    <label for="splash-login-member-select" class="block text-sm font-medium text-gray-700">S√©lectionner votre nom</label>
                    <select id="splash-login-member-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">-- Chargement des membres... --</option>
                    </select>
                </div>
                <div class="relative">
                    <label for="splash-auth-key-input" class="block text-sm font-medium text-gray-700">Cl√© de Connexion Secr√®te</label>
                    <input type="password" id="splash-auth-key-input" placeholder="Entrez la cl√©..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p id="splash-login-error-message" class="text-red-500 text-xs mt-1 hidden">Nom ou cl√© incorrect(e).</p>
                </div>
                <button id="splash-team-login-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Se Connecter</button>
            </div>

             <!-- Placeholder for critical errors -->
            <div id="critical-error-message" class="text-red-600 text-center text-sm hidden"></div>
        </div>
    </div>


    <!-- Main Application Container (Hidden until logged in) -->
    <div id="app-container" class="min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Campagne √âlectorale Consulaires 2026</h1>
                <div id="user-info" class="text-sm text-gray-500 flex items-center space-x-4">
                    <span class="font-medium text-gray-700">Connect√©:</span> <span id="user-id" class="break-all font-semibold text-gray-900">Non Connect√©</span>
                    <span id="team-member-status" class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 hidden"></span>
                    <button id="team-logout-btn" class="inline-flex justify-center py-1 px-3 border border-transparent shadow-sm text-xs font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">D√©connexion</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-gray-800 text-white" id="main-nav">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-center h-16">
                    <div class="flex items-baseline space-x-4">
                        <!-- Dashboard and Projections hidden for non-admins -->
                        <a href="#" id="nav-dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium hidden">Tableau de Bord</a>
                        <a href="#" id="nav-contacts" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Gestion des Contacts</a>
                        <a href="#" id="nav-team" class="nav-link px-3 py-2 rounded-md text-sm font-medium">√âquipe</a>
                        <a href="#" id="nav-projections" class="nav-link px-3 py-2 rounded-md text-sm font-medium hidden">Projections</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                
                <!-- Loading Indicator (Only shown briefly during Firebase auth) -->
                <div id="loading-indicator" class="text-center p-8 text-lg font-medium text-blue-600 hidden">
                    Connexion aux services de donn√©es...
                </div>

                <!-- Dashboard View -->
                <div id="dashboard-view" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">Contacts G√©r√©s</h3><p id="kpi-total-contacts" class="text-3xl font-bold text-gray-900">0</p></div>
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">Votes "Certains"</h3><p id="kpi-certain-votes" class="text-3xl font-bold text-blue-600">0</p></div>
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">A Vot√© (Jour J)</h3><p id="kpi-has-voted" class="text-3xl font-bold text-violet-600">0</p></div>
                        <div class="kpi-card"><h3 class="text-gray-500 text-sm font-medium">Votes Projet√©s (pond√©r√©s)</h3><p id="kpi-projected-votes" class="text-3xl font-bold text-green-600">0</p></div>
                    </div>

                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <h3 id="goal-title" class="text-lg font-medium text-gray-900 mb-2">Objectif de 1000 votes certains</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="goal-progress-bar" class="bg-blue-600 h-4 rounded-full text-center text-white text-xs" style="width: 0%;"></div>
                        </div>
                        <p id="goal-progress-text" class="text-right text-sm text-gray-600 mt-1">0 / 1000</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">R√©partition des Contacts</h3>
                            <canvas id="status-chart"></canvas>
                        </div>
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Anniversaires √† venir (30 jours)</h3>
                            <div id="birthday-list" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500">Aucun anniversaire dans les 30 prochains jours.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacts View -->
                <div id="contacts-view" class="hidden">
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                             <div>
                                <h2 class="text-xl font-bold text-gray-800">Gestion G√©n√©rale des Contacts</h2>
                                <p class="text-sm text-gray-500">Importez, recherchez et assignez des contacts √† votre √©quipe.</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="csv-file-input" class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Importer un CSV
                                    <input id="csv-file-input" type="file" accept=".csv" class="hidden">
                                </label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="search-contacts" placeholder="Rechercher par nom, pr√©nom, email..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="contact-list-container overflow-x-auto max-h-[60vh] relative">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√©nom(s)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√©l√©phone</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsable</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="contacts-table-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Team View -->
                <div id="team-view" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- Col 1: Team Management & Login -->
                        <div class="lg:col-span-1 bg-white shadow rounded-lg p-6 space-y-6">
                            
                            <!-- Team Member Login (Simplified: connection is now via splash screen) -->
                            <div class="border-b pb-4 mb-4">
                                <h2 class="text-xl font-bold text-blue-600 mb-4">Statut de Connexion</h2>
                                <p id="current-member-info" class="text-lg font-semibold text-gray-700"></p>
                                <p id="is-admin-info" class="text-sm mt-1 text-green-600 font-medium hidden">ACC√àS ADMINISTRATEUR</p>
                            </div>

                            <!-- Admin: Add Team Member -->
                            <div id="admin-member-creation-panel" class="hidden">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Ajouter un Membre (Admin)</h2>
                                <p class="text-sm text-gray-500 mb-4">Une cl√© d'authentification unique sera g√©n√©r√©e. (Damien = Admin)</p>
                                <div>
                                    <label for="new-team-member" class="block text-sm font-medium text-gray-700">Nom du membre</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="new-team-member" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md sm:text-sm border-gray-300 px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                        <button id="add-team-member-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm hover:bg-gray-100">
                                            Ajouter
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Admin: Team List & Keys -->
                            <div id="admin-team-list-panel" class="hidden">
                                <h3 class="text-lg font-medium text-gray-700 mt-6">Liste des Membres et Cl√©s</h3>
                                <div id="team-list" class="space-y-2 pt-2 text-xs">
                                   <!-- List of team members with keys and delete button -->
                                </div>
                            </div>
                        </div>

                        <!-- Col 2/3: Contacts Assigned -->
                        <div class="lg:col-span-2 bg-white shadow rounded-lg p-6">
                            <div id="team-member-contact-view">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Contacts Assign√©s</h2>
                                <p class="text-sm text-gray-500">Visualisation et mise √† jour de votre portefeuille de contacts.</p>
                                
                                <!-- Admin Selector (Optional - for admin to view others' lists) -->
                                <div id="admin-view-selector" class="mt-4 mb-4 p-3 bg-gray-50 rounded-lg border hidden">
                                    <label for="admin-team-member-select" class="block text-xs font-medium text-gray-700">Vue Admin: Voir la liste de</label>
                                    <select id="admin-team-member-select" class="mt-1 block w-full pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                        <option value="">-- S√©lectionner un membre --</option>
                                    </select>
                                </div>


                                <p id="team-contact-placeholder" class="text-gray-500 mt-6">Veuillez vous connecter pour voir votre liste de contacts.</p>
                                <div id="team-contact-list-container" class="hidden contact-list-container overflow-x-auto max-h-[60vh] relative">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nom</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pr√©nom(s)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">T√©l√©phone (Contr√¥le)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut (Campagne)</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">A Vot√© (Jour J)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="team-contacts-table-body" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projections View -->
                <div id="projections-view" class="hidden">
                     <div class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1 bg-white shadow rounded-lg p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Param√®tres de la Simulation</h2>
                                <div class="space-y-6">
                                    <div>
                                        <label for="total-inscrits" class="block text-sm font-medium text-gray-700">Nombre total d'inscrits (LEC)</label>
                                        <input type="number" id="total-inscrits" value="18000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="turnout" class="block text-sm font-medium text-gray-700">Taux de participation estim√© (%)</label>
                                        <input type="number" id="turnout" value="25" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="num-lists" class="block text-sm font-medium text-gray-700">Nombre de listes en comp√©tition</label>
                                        <input type="number" id="num-lists" value="4" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                     <div>
                                        <label for="objective-seats" class="block text-sm font-medium text-gray-700">Nombre de si√®ges vis√©s (Objectif)</label>
                                        <input type="number" id="objective-seats" value="1" min="1" max="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <button id="run-projection" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Lancer la Projection</button>
                                </div>
                            </div>
                            <div class="lg:col-span-2 bg-white shadow rounded-lg p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">R√©sultats de la Projection</h2>
                                <div id="projection-results" class="space-y-4">
                                   <p class="text-gray-500">Veuillez configurer les param√®tres et lancer la projection pour voir les r√©sultats.</p>
                                </div>
                                <div id="projection-summary-table" class="mt-6"></div>
                            </div>
                        </div>
                        <div class="bg-white shadow rounded-lg p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">√âvolution de la Campagne</h2>
                            <canvas id="history-chart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Chart.js for the doughnut chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, setDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set Firebase Log Level to debug for development/testing
        setLogLevel('Debug');

        // --- GLOBAL FIREBASE/APP VARIABLES ---
        let db;
        let auth;
        let userId = 'anonymous'; // Default until authenticated
        
        // *******************************************************************
        // CONFIGURATION FIREBASE - LOGIQUE DE CHARGEMENT ROBUSTE
        // *******************************************************************
        
        // Configuration de secours (fall-back) avec les valeurs fournies
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyBy_3k0dPsPCN5b_iOfZl22eJoq8BWbaRo",
            authDomain: "elecmanager-6f50a.firebaseapp.com",
            projectId: "elecmanager-6f50a",
            storageBucket: "elecmanager-6f50a.firebasestorage.app",
            messagingSenderId: "872950170067",
            appId: "1:872950170067:web:dc23cc105538d3e88baf26",
            measurementId: "G-GXP88CTD96"
        };
        const hardcodedAppId = hardcodedFirebaseConfig.appId;

        let configSource = hardcodedFirebaseConfig;
        
        // Tentative de r√©cup√©ration des variables de l'environnement Gemini
        const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedAppId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        if (typeof __firebase_config !== 'undefined' && __firebase_config.length > 0) {
            try {
                const parsedConfig = JSON.parse(__firebase_config);
                if (parsedConfig && parsedConfig.projectId) {
                    configSource = parsedConfig; // Utiliser la config inject√©e si disponible
                }
            } catch (e) {
                console.warn("Firebase: Parsing de __firebase_config √©chou√©. Utilisation de la configuration de repli.");
            }
        } 
        
        const firebaseConfig = configSource;

        // --- GLOBAL STATE ---
        window.contacts = [];
        window.teamMembers = [];
        window.projectionHistory = [];
        window.votesGoal = 1000;
        window.isAuthReady = false; // Flag to ensure listeners start only after auth
        window.currentTeamMemberId = null; // State for logged-in team member
        window.currentTeamMemberName = null;
        window.isAdmin = false; // New state for role-based access control
        let historyChartInstance = null; // Instance for the evolution chart

        const STATUS_OPTIONS = {
            '√Ä contacter': '√Ä contacter', '√Ä convaincre': '√Ä convaincre', 'Probable': 'Probable',
            'Acquis': 'Acquis', 'Refus': 'Refus', 'A vot√©': 'A vot√©'
        };

        const STATUS_COLORS = {
            '√Ä contacter': '#9ca3af', '√Ä convaincre': '#f59e0b', 'Probable': '#84cc16',
            'Acquis': '#2563eb', 'Refus': '#ef4444', 'A vot√©': '#8b5cf6'
        };
        
        const TEAM_STATUS_OPTIONS = {
            '√Ä contacter': '√Ä contacter', '√Ä convaincre': '√Ä convaincre', 'Probable': 'Probable',
            'Acquis': 'Acquis', 'Refus': 'Refus'
        };
        
        // --- FIRESTORE UTILS ---
        // Public collection path for collaborative team data
        function getPublicCollectionRef(collectionName) {
            return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
        }
        
        // Private collection for user-specific data (e.g., projection history)
        function getPrivateCollectionRef(collectionName) {
            return collection(db, 'artifacts', appId, 'users', userId, collectionName);
        }

        // --- FIRESTORE LISTENERS (Real-time updates) ---
        function loadPublicData() {
            if (!db) return;
            
            // NOTE IMPORTANTE: Pour que ces √©couteurs fonctionnent, les r√®gles de s√©curit√© Firestore
            // DOIVENT autoriser la lecture pour les utilisateurs non authentifi√©s/anonymes sur ces chemins (read: if true).

            // 1. Listen for Team Members (Public/Shared data)
            onSnapshot(getPublicCollectionRef('teamMembers'), (snapshot) => {
                window.teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.updateAll();
                window.updateLoginSelect(); // Keep the splash screen's select up to date
            }, (error) => console.error("Error fetching team members:", error));
            
            // 2. Listen for Contacts (Public/Shared data)
            onSnapshot(getPublicCollectionRef('contacts'), (snapshot) => {
                window.contacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.updateAll();
            }, (error) => console.error("Error fetching contacts:", error));

        }

        function setupPrivateDataListeners() {
            if (!db || !window.isAuthReady) return;
            
            // 3. Listen for Projection History (User-specific private data)
            // Cet √©couteur ne d√©marre qu'apr√®s une connexion r√©ussie et l'authentification de l'utilisateur
            onSnapshot(getPrivateCollectionRef('projectionHistory'), (snapshot) => {
                window.projectionHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.timestamp - b.timestamp);
                
                const lastHistory = window.projectionHistory[window.projectionHistory.length - 1];
                if (lastHistory && lastHistory.goal) {
                    window.votesGoal = lastHistory.goal;
                }
                window.updateAll();
            }, (error) => console.error("Error fetching history:", error));
        }


        // --- FIREBASE INITIALIZATION & AUTH ---
        async function initializeFirebase() {
            console.log("Configuration Firebase finale utilis√©e:", firebaseConfig);

            if (!firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                const errorMsg = "Erreur critique: apiKey, authDomain, ou projectId manquant. V√©rifiez vos variables.";
                console.error(errorMsg);
                document.getElementById('critical-error-message').textContent = errorMsg;
                document.getElementById('critical-error-message').classList.remove('hidden');
                document.getElementById('splash-login-card').classList.add('hidden');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                
                // 1. Authentification en utilisant le jeton personnalis√© (Canvas) ou l'anonyme
                if (initialAuthToken) {
                     // Utilisation du jeton fourni par l'environnement Canvas pour une connexion fiable
                     await signInWithCustomToken(auth, initialAuthToken);
                } else {
                     // Fallback: Authentification anonyme
                     await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID(); 
                window.isAuthReady = true;

                // 2. D√©marrer l'√©coute des donn√©es publiques (membres d'√©quipe, contacts) imm√©diatement.
                // Cela est fait apr√®s l'authentification (m√™me anonyme) pour respecter les r√®gles de s√©curit√©.
                loadPublicData();
                
                // 3. Cacher l'indicateur de chargement
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('user-id').textContent = 'Non Connect√©';

                // 4. L'√©couteur d'√©tat d'authentification g√®re le changement d'ID utilisateur
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; 
                        // Note: setupPrivateDataListeners() sera appel√© apr√®s la connexion manuelle r√©ussie
                    }
                });

                // 5. Assurer que le splash screen est visible pour la connexion manuelle
                document.getElementById('login-splash-view').classList.remove('hidden');

            } catch (error) {
                console.error("Erreur d'initialisation ou d'authentification Firebase:", error);
                
                let displayMessage = "Erreur de connexion aux services de donn√©es: " + error.message;

                if (error.code === 'auth/configuration-not-found' || error.message.includes('auth/configuration-not-found')) {
                     displayMessage = `Erreur critique : Firebase Auth Configuration Not Found. Veuillez **activer la m√©thode de connexion Anonyme** dans votre console Firebase.`;
                }

                document.getElementById('critical-error-message').innerHTML = displayMessage;
                document.getElementById('critical-error-message').classList.remove('hidden');
            }
        }
        
        // --- FIRESTORE ACTIONS ---
        async function saveContact(contact) {
            if (!db) return;
            const contactRef = doc(getPublicCollectionRef('contacts'), contact.id);
            try {
                const dataToSave = {
                    ...contact,
                    numeroTelephone: contact.numeroTelephone || null,
                    assignedTo: contact.assignedTo || null,
                    controlledByMemberId: contact.controlledByMemberId || null,
                    controlledByMemberName: contact.controlledByMemberName || null,
                };
                delete dataToSave.id;
                await setDoc(contactRef, dataToSave);
            } catch (e) {
                console.error("Error saving document:", e);
            }
        }
        
        async function deleteContact(contactId) {
            if (!db) return;
            const contactRef = doc(getPublicCollectionRef('contacts'), contactId);
            try {
                await deleteDoc(contactRef);
            } catch (e) {
                console.error("Error deleting document:", e);
            }
        }

        async function addTeamMember(name) {
             if (!db) return;
             // Set isAdmin: true if the name is Damien (case-insensitive)
             const isAdmin = name.trim().toLowerCase() === 'damien';
             try {
                 const newDoc = await addDoc(getPublicCollectionRef('teamMembers'), { 
                     name: name,
                     authKey: crypto.randomUUID().substring(0, 8),
                     isAdmin: isAdmin // New field for role-based access control
                 });
                 return newDoc.id; 
             } catch (e) {
                 console.error("Error adding team member:", e);
                 return null;
             }
        }

        async function deleteTeamMember(memberId) {
             if (!db) return;
             const memberRef = doc(getPublicCollectionRef('teamMembers'), memberId);
             try {
                 await deleteDoc(memberRef);
             } catch (e) {
                 console.error("Error deleting team member:", e);
             }
        }
        
        async function addProjectionHistory(data) {
             if (!db) return;
             try {
                 await addDoc(getPrivateCollectionRef('projectionHistory'), data);
             } catch (e) {
                 console.error("Error adding history:", e);
             }
        }

        // --- MAIN APP LOGIC (Attached to window for global access) ---
        window.updateAll = function() {
            if (!window.currentTeamMemberId) {
                // If not logged in as a team member, just update the login select
                window.updateLoginSelect();
                return;
            }
            
            // If logged in, update app components
            window.renderContacts();
            window.updateDashboard();
            window.updateTeamStatusDisplay();
            window.toggleNavVisibility(window.isAdmin);

            if (!document.getElementById('team-view').classList.contains('hidden')) {
                window.renderTeamView();
            }
             if (!document.getElementById('projections-view').classList.contains('hidden')) {
                window.updateHistoryChart();
            }
        }

        // Toggles visibility of Dashboard and Projections in the navigation
        window.toggleNavVisibility = function(isAdmin) {
            document.getElementById('nav-dashboard').classList.toggle('hidden', !isAdmin);
            document.getElementById('nav-projections').classList.toggle('hidden', !isAdmin);
        }

        window.updateTeamStatusDisplay = function() {
            const userIdDisplayEl = document.getElementById('user-id');
            const statusEl = document.getElementById('team-member-status');
            const memberInfoEl = document.getElementById('current-member-info');
            const adminInfoEl = document.getElementById('is-admin-info');

            if (window.currentTeamMemberId) {
                // Afficher le nom du membre au lieu du Firebase UID
                userIdDisplayEl.textContent = window.currentTeamMemberName;
                
                statusEl.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800');
                statusEl.classList.add('bg-green-100', 'text-green-800');
                statusEl.textContent = `Connect√©: ${window.currentTeamMemberName}`;
                
                memberInfoEl.textContent = `Connect√© en tant que: ${window.currentTeamMemberName}`;
                
                adminInfoEl.classList.toggle('hidden', !window.isAdmin);

            } else {
                userIdDisplayEl.textContent = 'Non Connect√©'; // Afficher 'Non Connect√©' si d√©connect√©
                statusEl.classList.add('hidden');
                memberInfoEl.textContent = 'Non connect√©.';
                adminInfoEl.classList.add('hidden');
            }
        }
        
        window.updateDashboard = function() {
            const totalContacts = window.contacts.length;
            const statusCounts = window.contacts.reduce((acc, contact) => {
                acc[contact.status] = (acc[contact.status] || 0) + 1;
                return acc;
            }, {});

            const certainVotes = statusCounts['Acquis'] || 0;
            const hasVoted = statusCounts['A vot√©'] || 0;

            const projectedVotes = Math.round(
                certainVotes +
                (statusCounts['Probable'] || 0) * 0.7 +
                (statusCounts['√Ä convaincre'] || 0) * 0.2
            );

            document.getElementById('kpi-total-contacts').textContent = totalContacts;
            document.getElementById('kpi-certain-votes').textContent = certainVotes;
            document.getElementById('kpi-has-voted').textContent = hasVoted;
            document.getElementById('kpi-projected-votes').textContent = projectedVotes + hasVoted;

            const goal = window.votesGoal;
            const currentCertain = certainVotes + hasVoted;
            const progress = Math.min((currentCertain / goal) * 100, 100);
            const progressBar = document.getElementById('goal-progress-bar');
            
            document.getElementById('goal-title').textContent = `Objectif de ${goal.toLocaleString()} votes certains`;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = progress > 10 ? `${Math.round(progress)}%` : '';
            document.getElementById('goal-progress-text').textContent = `${currentCertain.toLocaleString()} / ${goal.toLocaleString()}`;

            window.updateStatusChart(statusCounts);
            window.updateBirthdayAlerts();
        }

        window.updateStatusChart = function(statusCounts) {
            let statusChart = window.statusChart; // Access global chart instance
            const ctx = document.getElementById('status-chart').getContext('2d');
            const labels = Object.keys(STATUS_OPTIONS);
            const data = labels.map(label => statusCounts[label] || 0);
            const backgroundColors = labels.map(label => STATUS_COLORS[label]);

            if (statusChart) {
                statusChart.data.labels = labels;
                statusChart.data.datasets[0].data = data;
                statusChart.data.datasets[0].backgroundColor = backgroundColors;
                statusChart.update();
            } else {
                window.statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data, backgroundColor: backgroundColors, borderWidth: 1 }] },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: false } } }
                });
            }
        }
        
        window.updateBirthdayAlerts = function() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thirtyDaysFromNow = new Date(today);
            thirtyDaysFromNow.setDate(today.getDate() + 30);

            const upcomingBirthdays = window.contacts.filter(c => {
                if (!c.dateNaissance) return false;
                try {
                    const parts = c.dateNaissance.split('/');
                    if (parts.length !== 3) return false;
                    const [day, month, year] = parts.map(p => parseInt(p, 10));
                    if(isNaN(day) || isNaN(month) || isNaN(year)) return false;

                    let birthDate = new Date(today.getFullYear(), month - 1, day);
                    if(birthDate < today) {
                       birthDate.setFullYear(today.getFullYear() + 1);
                    }
                    return birthDate >= today && birthDate <= thirtyDaysFromNow;
                } catch(e) { return false; }
            }).sort((a,b) => {
                const partsA = a.dateNaissance.split('/');
                const partsB = b.dateNaissance.split('/');
                if(partsA.length < 3 || partsB.length < 3) return 0;

                const [dayA, monthA] = partsA;
                const [dayB, monthB] = partsB;
                let dateA = new Date(today.getFullYear(), parseInt(monthA)-1, parseInt(dayA));
                let dateB = new Date(today.getFullYear(), parseInt(monthB)-1, parseInt(dayB));
                if(dateA < today) dateA.setFullYear(today.getFullYear() + 1);
                if(dateB < today) dateB.setFullYear(today.getFullYear() + 1);
                return dateA - dateB;
            });
            
            const birthdayListEl = document.getElementById('birthday-list');
            birthdayListEl.innerHTML = upcomingBirthdays.length > 0
                ? upcomingBirthdays.map(c => {
                    const parts = c.dateNaissance.split('/');
                    if(parts.length < 3) return '';
                    const [day, month, year] = parts;
                    const age = today.getFullYear() - parseInt(year, 10);
                    return `<div class="flex justify-between items-center text-sm">
                                <p class="font-medium text-gray-800">${c.prenoms} ${c.nomUsage}</p>
                                <p class="text-gray-500">${day}/${month} (aura ${age + 1} ans)</p>
                            </div>`;
                  }).join('')
                : '<p class="text-gray-500">Aucun anniversaire dans les 30 prochains jours.</p>';
        }

        // --- CONTACTS MANAGEMENT ---
        window.renderContacts = function(filteredContacts = null) {
            // RBAC: Non-admin users only see contacts assigned to them
            const isContactAccessRestricted = !window.isAdmin && !document.getElementById('team-view').classList.contains('hidden');

            const tableBody = document.getElementById('contacts-table-body');
            tableBody.innerHTML = '';
            
            let contactsToRender = filteredContacts || window.contacts;
            
            if (isContactAccessRestricted) {
                // If on 'team' view AND not admin, only show self-assigned contacts in the general list (for coherence, though they use the team list primarily)
                contactsToRender = contactsToRender.filter(c => c.assignedTo === window.currentTeamMemberId);
            }
            
            const teamMembersOptions = window.teamMembers.map(tm => `<option value="${tm.id}">${tm.name}</option>`).join('');

            contactsToRender.forEach(contact => {
                const row = document.createElement('tr');
                const contactTeamOptions = window.teamMembers.map(tm => 
                    `<option value="${tm.id}" ${contact.assignedTo == tm.id ? 'selected' : ''}>${tm.name}</option>`
                ).join('');
                
                const deleteButton = window.isAdmin ? `<button data-id="${contact.id}" class="delete-btn text-red-600 hover:text-red-900">Supprimer</button>` : '';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${contact.nomUsage || contact.nomNaissance}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.prenoms}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.numeroTelephone || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="color: ${STATUS_COLORS[contact.status]}; background-color: ${STATUS_COLORS[contact.status]}20;">${contact.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 relative">
                         <select data-id="${contact.id}" class="assign-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-xs" ${!window.isAdmin ? 'disabled' : ''}>
                            <option value="">Non assign√©</option>
                            ${contactTeamOptions}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${deleteButton}
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.assign-select').forEach(select => select.addEventListener('change', handleAssignContact));
            document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', handleDeleteContact));
        }
        
        function handleAssignContact(event) {
            if (!window.isAdmin) return;
            const contactId = event.target.dataset.id;
            const newMemberId = event.target.value; 
            const contact = window.contacts.find(c => c.id == contactId);

            if (contact) {
                const contactToUpdate = {...contact};
                contactToUpdate.assignedTo = newMemberId || null;
                saveContact(contactToUpdate);
            }
        }

        function handleDeleteContact(event) {
            if (!window.isAdmin) return;
            const contactId = event.target.dataset.id;
            
            if (window.confirm('√ätes-vous s√ªr de vouloir supprimer ce contact ?')) {
                deleteContact(contactId); 
            }
        }

        document.getElementById('search-contacts').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = window.contacts.filter(c => 
                (c.nomUsage && c.nomUsage.toLowerCase().includes(searchTerm)) ||
                (c.prenoms && c.prenoms.toLowerCase().includes(searchTerm)) ||
                (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                (c.numeroTelephone && c.numeroTelephone.toLowerCase().includes(searchTerm))
            );
            window.renderContacts(searchTerm.length > 2 ? filtered : null);
        });
        
        // --- TEAM MANAGEMENT ---
        
        window.updateLoginSelect = function() {
            const loginSelect = document.getElementById('splash-login-member-select');
            
            // Only update if we are on the splash screen
            if (loginSelect) {
                loginSelect.innerHTML = '<option value="">-- S√©lectionnez un responsable --</option>';
                 window.teamMembers.forEach(member => {
                    loginSelect.innerHTML += `<option value="${member.id}">${member.name}</option>`;
                });
            }
        }

        window.renderTeamView = function() {
            const adminSelect = document.getElementById('admin-team-member-select');
            const teamListDiv = document.getElementById('team-list');
            const adminCreationPanel = document.getElementById('admin-member-creation-panel');
            const adminTeamListPanel = document.getElementById('admin-team-list-panel');
            const adminViewSelector = document.getElementById('admin-view-selector');
            
            // RBAC: Show/Hide admin panels
            adminCreationPanel.classList.toggle('hidden', !window.isAdmin);
            adminTeamListPanel.classList.toggle('hidden', !window.isAdmin);
            
            // RBAC: Show Admin view selector if admin, and if the admin is currently viewing the list
            const adminSelectedMemberId = adminSelect.value;
            adminViewSelector.classList.toggle('hidden', !window.isAdmin);

            adminSelect.innerHTML = '<option value="">-- Vue Admin: S√©lectionner un membre --</option>';
            teamListDiv.innerHTML = '';

            window.teamMembers.forEach(member => {
                // For Admin View Selector
                adminSelect.innerHTML += `<option value="${member.id}" ${adminSelectedMemberId === member.id ? 'selected' : ''}>${member.name}</option>`;
                
                // For Admin List Display
                const assignedCount = window.contacts.filter(c => c.assignedTo === member.id).length;
                teamListDiv.innerHTML += `<div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <div>
                                                <span class="font-semibold">${member.name} (${assignedCount} contacts)</span><br>
                                                <span class="text-gray-500">Cl√©: 
                                                    <span class="font-mono text-blue-600">${member.authKey || 'N/A'}</span>
                                                </span>
                                                ${member.isAdmin ? '<span class="text-green-600 ml-2 font-bold">ADMIN</span>' : ''}
                                            </div>
                                            <button data-id="${member.id}" class="delete-member-btn text-red-500 hover:text-red-700 font-bold ml-4" ${!window.isAdmin ? 'disabled' : ''}>X</button>
                                          </div>`;
            });
            
            document.querySelectorAll('.delete-member-btn').forEach(btn => btn.addEventListener('click', handleDeleteTeamMember));

            // Determine which list to render: Logged-in member's list takes priority
            const memberIdToRender = window.currentTeamMemberId || adminSelectedMemberId;
            
            window.renderAssignedContacts(memberIdToRender);
        }

        function handleAddTeamMember() {
            if (!window.isAdmin) return;
            const input = document.getElementById('new-team-member');
            if (input.value.trim()) {
                addTeamMember(input.value.trim()); 
                input.value = '';
            }
        }

        function handleDeleteTeamMember(event) {
            if (!window.isAdmin) return;
            const memberId = event.target.dataset.id;
            
            if(window.confirm('Supprimer ce membre ? Les contacts assign√©s deviendront "Non assign√©" et leur contr√¥le sera rel√¢ch√©.')) {
                
                // Clear assignments and control fields for affected contacts
                window.contacts.filter(c => c.assignedTo === memberId || c.controlledByMemberId === memberId).forEach(c => {
                    const contactToUpdate = {...c};
                    if(contactToUpdate.assignedTo === memberId) contactToUpdate.assignedTo = null; 
                    if(contactToUpdate.controlledByMemberId === memberId) {
                        contactToUpdate.controlledByMemberId = null;
                        contactToUpdate.controlledByMemberName = null;
                        contactToUpdate.numeroTelephone = null; 
                    }
                    saveContact(contactToUpdate); 
                });
                
                // If the deleted member was logged in, log them out
                if (window.currentTeamMemberId === memberId) {
                    handleTeamLogout();
                }

                deleteTeamMember(memberId); 
            }
        }

        // Team Login Logic (from Splash Screen)
        function handleTeamLogin() {
            const memberId = document.getElementById('splash-login-member-select').value;
            const authKey = document.getElementById('splash-auth-key-input').value.trim();
            const errorEl = document.getElementById('splash-login-error-message');
            
            errorEl.classList.add('hidden');

            if (!memberId || !authKey) {
                errorEl.textContent = 'Veuillez s√©lectionner un nom et entrer une cl√©.';
                errorEl.classList.remove('hidden');
                return;
            }

            const member = window.teamMembers.find(m => m.id === memberId);
            
            if (member && member.authKey === authKey) {
                window.currentTeamMemberId = member.id;
                window.currentTeamMemberName = member.name;
                window.isAdmin = member.isAdmin || false; // Set admin status

                // Setup private data listeners (like projection history) now that we have a persistent user ID
                setupPrivateDataListeners();

                document.getElementById('splash-auth-key-input').value = ''; // Clear key input
                
                // Show main app, hide splash screen
                document.getElementById('login-splash-view').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                // Force non-admin users to the Team view
                const initialView = window.isAdmin ? 'dashboard' : 'team';
                showView(initialView);
                window.updateAll(); 
            } else {
                errorEl.textContent = 'Nom ou cl√© incorrect(e).';
                errorEl.classList.remove('hidden');
            }
        }

        function handleTeamLogout() {
            window.currentTeamMemberId = null;
            window.currentTeamMemberName = null;
            window.isAdmin = false;
            
            // Hide main app, show splash screen
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-splash-view').classList.remove('hidden');
            
            window.updateLoginSelect();
            window.updateTeamStatusDisplay();
        }

        window.renderAssignedContacts = function(memberId) {
            const container = document.getElementById('team-contact-list-container');
            const placeholder = document.getElementById('team-contact-placeholder');
            const tableBody = document.getElementById('team-contacts-table-body');
            
            placeholder.classList.toggle('hidden', !!memberId);
            container.classList.toggle('hidden', !memberId);
            
            if (!memberId) return;

            tableBody.innerHTML = '';
            // Only show contacts assigned to the current member (or the admin-selected member)
            const assigned = window.contacts.filter(c => c.assignedTo == memberId);
            const actingMember = window.teamMembers.find(m => m.id === memberId); 
            if (!actingMember) return; 
            
            const isActingAsSelf = window.currentTeamMemberId === memberId;
            
            assigned.forEach(contact => {
                const isControlledByAnother = contact.controlledByMemberId && contact.controlledByMemberId != memberId;
                
                // Disable controls unless acting as self AND it's not controlled by someone else
                const controlsDisabled = !isActingAsSelf || isControlledByAnother; 

                const row = document.createElement('tr');
                const statusOptionsHtml = Object.keys(TEAM_STATUS_OPTIONS).map(key => `<option value="${key}" ${contact.status === key ? 'selected' : ''}>${TEAM_STATUS_OPTIONS[key]}</option>`).join('');
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${contact.nomUsage}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${contact.prenoms}</td>
                    
                    <!-- PHONE NUMBER INPUT (Control mechanism) -->
                    <td class="px-6 py-4 text-sm text-gray-500 relative min-w-[150px]">
                        <input type="tel" data-id="${contact.id}" data-member-id="${memberId}" class="phone-input w-full rounded-md border-gray-300 shadow-sm text-xs px-2 py-1 focus:ring-blue-500 focus:border-blue-500" value="${contact.numeroTelephone || ''}" placeholder="Num√©ro (Contr√¥le)" ${controlsDisabled ? 'disabled' : ''}>
                        ${isControlledByAnother ? `<span class="controlled-message">G√©r√© par ${contact.controlledByMemberName || 'un autre membre'}.</span>` : ''}
                    </td>

                    <!-- Status Select -->
                    <td class="px-6 py-4 text-sm text-gray-500"><select data-id="${contact.id}" class="team-status-select w-full rounded-md border-gray-300 shadow-sm text-xs" ${contact.status === 'A vot√©' || controlsDisabled ? 'disabled' : ''}>${statusOptionsHtml}</select></td>
                    
                    <!-- Voted Checkbox -->
                    <td class="px-6 py-4 text-center"><input type="checkbox" data-id="${contact.id}" class="voted-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" ${contact.status === 'A vot√©' || controlsDisabled ? 'checked disabled' : (controlsDisabled ? 'disabled' : '')}></td>`;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.phone-input:not([disabled])').forEach(input => input.addEventListener('change', handlePhoneNumberChange));
            document.querySelectorAll('.team-status-select:not([disabled])').forEach(s => s.addEventListener('change', handleTeamStatusChange));
            document.querySelectorAll('.voted-checkbox:not([disabled])').forEach(cb => cb.addEventListener('change', handleVotedChange));
        }
        
        function handlePhoneNumberChange(event) {
            const contactId = event.target.dataset.id;
            const newPhoneNumber = event.target.value.trim();
            const contact = window.contacts.find(c => c.id == contactId);
            const actingMemberId = event.target.dataset.memberId;
            const actingMember = window.teamMembers.find(m => m.id === actingMemberId);

            if (!contact || !actingMember) return;
            
            const isControlledByAnother = contact.controlledByMemberId && contact.controlledByMemberId !== actingMemberId;
            
            if (isControlledByAnother) {
                event.target.value = contact.numeroTelephone || ''; 
                console.warn("Attempt to change phone number rejected: Controlled by another member.");
                return; 
            }
            
            const contactToUpdate = {...contact};

            if (newPhoneNumber.length > 0) {
                contactToUpdate.numeroTelephone = newPhoneNumber;
                contactToUpdate.controlledByMemberId = actingMemberId;
                contactToUpdate.controlledByMemberName = actingMember.name;
            } else {
                // Releasing control
                contactToUpdate.numeroTelephone = null;
                contactToUpdate.controlledByMemberId = null;
                contactToUpdate.controlledByMemberName = null;
            }
            saveContact(contactToUpdate); 
        }

        function handleTeamStatusChange(event) {
            const contact = window.contacts.find(c => c.id == event.target.dataset.id);
            if (contact) {
                 const contactToUpdate = {...contact};
                contactToUpdate.status = event.target.value;
                if(contactToUpdate.status === 'A vot√©') {
                    // Update checkbox if status is set to 'A vot√©'
                    const checkbox = document.querySelector(`.voted-checkbox[data-id="${contact.id}"]`);
                    if(checkbox) checkbox.checked = true;
                }
                saveContact(contactToUpdate); 
            }
        }

        function handleVotedChange(event) {
             const contact = window.contacts.find(c => c.id == event.target.dataset.id);
             if (contact) {
                const contactToUpdate = {...contact};
                // Set status to 'A vot√©' if checked, otherwise default back to 'Acquis' (the strongest non-voted status)
                contactToUpdate.status = event.target.checked ? 'A vot√©' : 'Acquis';
                const select = document.querySelector(`.team-status-select[data-id="${contact.id}"]`);
                if(select) select.value = contactToUpdate.status;
                saveContact(contactToUpdate); 
             }
        }

        // New Login/Logout button handlers
        document.getElementById('splash-team-login-btn').addEventListener('click', handleTeamLogin);
        document.getElementById('team-logout-btn').addEventListener('click', handleTeamLogout);
        
        document.getElementById('add-team-member-btn').addEventListener('click', handleAddTeamMember);
        document.getElementById('admin-team-member-select').addEventListener('change', (e) => window.renderAssignedContacts(e.target.value));

        // --- CSV IMPORT ---
        document.getElementById('csv-file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => processCSV(e.target.result);
                reader.readAsText(file, 'UTF-8');
            }
        });

        async function processCSV(csvText) {
            if (!db) {
                console.error("Erreur: La base de donn√©es n'est pas connect√©e. Veuillez r√©essayer.");
                return;
            }
            
            const firstLine = csvText.split(/\r\n|\n/)[0];
            const delimiter = firstLine.includes(';') ? ';' : ',';

            const lines = csvText.split(/\r\n|\n/).slice(1);
            const newContacts = lines.filter(line => line.trim() !== '').map((line) => {
                const data = line.split(new RegExp(`[${delimiter}]`)).map(d => d.trim().replace(/"/g, ''));
                 const contact = {
                    status: '√Ä contacter', 
                    nomNaissance: data[0] || '', 
                    nomUsage: data[1] || '',
                    prenoms: data[2] || '', 
                    dateNaissance: data[3] || '', // Assuming format DD/MM/YYYY
                    email: data[9] || '', 
                    assignedTo: null,
                    numeroTelephone: null, 
                    controlledByMemberId: null,
                    controlledByMemberName: null
                };
                if (!contact.nomUsage) contact.nomUsage = contact.nomNaissance;
                return contact;
            }).filter(c => c.nomUsage || c.prenoms);
            
            if (window.confirm(`Importer ${newContacts.length} nouveaux contacts ?`)) {
                let importedCount = 0;
                for (const contact of newContacts) {
                    try {
                        await addDoc(getPublicCollectionRef('contacts'), contact);
                        importedCount++;
                    } catch (e) {
                        console.error("Erreur lors de l'importation d'un contact:", e);
                    }
                }
                console.log(`${importedCount} contacts import√©s.`);
                document.getElementById('csv-file-input').value = '';
            }
        }
        
        // --- PROJECTION LOGIC ---
        document.getElementById('run-projection').addEventListener('click', runProjection);
        async function runProjection() {
             if (!window.isAdmin) return; // Projection is admin only

            const totalInscrits = parseInt(document.getElementById('total-inscrits').value);
            const turnout = parseFloat(document.getElementById('turnout').value);
            const numLists = parseInt(document.getElementById('num-lists').value);
            const objectiveSeats = parseInt(document.getElementById('objective-seats').value);
            const SEATS_TO_FILL = 5; 

            if (isNaN(totalInscrits) || isNaN(turnout) || isNaN(numLists) || numLists < 1 || isNaN(objectiveSeats)) return;

            const statusCounts = window.contacts.reduce((acc, c) => ({...acc, [c.status]: (acc[c.status] || 0) + 1 }), {});
            
            const ourVotes = Math.round(
                (statusCounts['A vot√©'] || 0) + (statusCounts['Acquis'] || 0) * 1 +
                (statusCounts['Probable'] || 0) * 0.7 + (statusCounts['√Ä convaincre'] || 0) * 0.2
            );

            const totalVotants = Math.round(totalInscrits * (turnout / 100));
            const quotient = Math.floor(totalVotants / SEATS_TO_FILL);
            
            window.votesGoal = quotient > 0 ? quotient : 1000;
            
            const historyEntry = { 
                timestamp: Date.now(), 
                counts: statusCounts, 
                goal: window.votesGoal,
                ourVotes: ourVotes 
            };
            await addProjectionHistory(historyEntry);

            let allLists = [{ name: "Votre Liste", votes: ourVotes, seats: 0 }];
            const otherVotes = totalVotants > ourVotes ? totalVotants - ourVotes : 0;
            
            // Simulate rival lists (adjusting votes so total equals totalVotants)
            if (numLists > 1) {
                const numRivalLists = numLists - 1;
                const baseVote = otherVotes / numRivalLists;
                let simulatedTotal = 0;
                
                for (let i = 1; i < numLists; i++) {
                    // Slight random variance for realism
                    const variance = baseVote * (0.8 + Math.random() * 0.4); 
                    const simulatedVotes = Math.round(variance);
                    allLists.push({ name: `Liste Adverse ${i}`, votes: simulatedVotes, seats: 0 });
                    simulatedTotal += simulatedVotes;
                }
                
                const currentTotalRival = allLists.slice(1).reduce((sum, list) => sum + list.votes, 0);
                const adjustmentNeeded = otherVotes - currentTotalRival;

                if (numRivalLists > 0 && allLists[1]) {
                    // Distribute remaining adjustment to the first rival list
                    allLists[1].votes += adjustmentNeeded;
                }

                
            }
            
            let seatsAttributed = 0, stepLog = '';
            let currentAllLists = JSON.parse(JSON.stringify(allLists)); 
            
            // 1. Attribution au quotient
            if (quotient > 0) {
                currentAllLists.forEach(list => {
                    const seatsWon = Math.floor(list.votes / quotient);
                    list.seats += seatsWon;
                    seatsAttributed += seatsWon;
                    if(seatsWon > 0) stepLog += `<li><strong>Tour au quotient :</strong> ${list.name} obtient ${seatsWon} si√®ge(s).</li>`;
                });
            }
            
            // 2. Attribution √† la plus forte moyenne (D'Hondt) pour les si√®ges restants
            while(seatsAttributed < SEATS_TO_FILL) {
                let bestList = null;
                let maxAvg = -1;

                currentAllLists.forEach(list => {
                    // D'Hondt formula: Votes / (Seats + 1)
                    const currentAvg = list.votes / (list.seats + 1); 
                    if (currentAvg > maxAvg) {
                        maxAvg = currentAvg;
                        bestList = list;
                    }
                });

                if (bestList && maxAvg > 0) {
                    bestList.seats++;
                    seatsAttributed++;
                    stepLog += `<li><strong>Tour forte moyenne :</strong> ${bestList.name} obtient 1 si√®ge (Moyenne: ${Math.round(maxAvg).toLocaleString()}).</li>`;
                } else break;
            }
            
            const ourResult = currentAllLists.find(l => l.name === "Votre Liste");
            const isObjectiveMet = ourResult.seats >= objectiveSeats;
            const resultColor = isObjectiveMet ? 'text-green-600' : 'text-red-600';
            
            document.getElementById('projection-results').innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800">Synth√®se de la Projection</h3>
                <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                    <div class="p-4 bg-gray-100 rounded-lg"><p class="text-sm text-gray-600">Total Votants Estim√©</p><p class="text-2xl font-bold">${totalVotants.toLocaleString()}</p></div>
                    <div class="p-4 bg-gray-100 rounded-lg"><p class="text-sm text-gray-600">Quotient √âlectoral</p><p class="text-2xl font-bold">${quotient > 0 ? quotient.toLocaleString() : 'N/A'}</p></div>
                </div>
                
                <p class="text-xl font-bold ${resultColor} mb-4 text-center">Objectif de ${objectiveSeats} si√®ge(s) : ${isObjectiveMet ? 'ATTEINT' : 'NON ATTEINT'}</p>

                <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-2">R√©partition finale des si√®ges (M√©thode D'Hondt)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Liste</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Votes Projet√©s</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Si√®ges Obtenus</th></tr></thead>
                        <tbody>${currentAllLists.sort((a,b) => b.votes - a.votes).map(l => 
                            `<tr class="${l.name === 'Votre Liste' ? 'bg-blue-50 font-semibold' : ''}">
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${l.name}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${l.votes.toLocaleString()}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${l.seats}</td>
                            </tr>`
                        ).join('')}</tbody>
                    </table>
                </div>

                <details class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <summary class="font-semibold text-gray-700 cursor-pointer">D√©tail de l'attribution des si√®ges</summary>
                    <ol class="list-disc pl-5 mt-2 text-sm text-gray-600 space-y-1">${stepLog}</ol>
                </details>
            `;
            
            window.updateAll();
        }

        window.updateHistoryChart = function() {
            const ctx = document.getElementById('history-chart').getContext('2d');
            const history = window.projectionHistory;

            if (history.length === 0) {
                if (historyChartInstance) historyChartInstance.destroy();
                document.getElementById('history-chart').style.display = 'none';
                return;
            }
             document.getElementById('history-chart').style.display = 'block';

            const data = {
                labels: history.map((entry, index) => `Proj. ${index + 1} (${new Date(entry.timestamp).toLocaleDateString()})`),
                datasets: [{
                    label: 'Votes Projet√©s',
                    data: history.map(entry => entry.ourVotes),
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            };

            if (historyChartInstance) {
                historyChartInstance.data = data;
                historyChartInstance.update();
            } else {
                historyChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' }, title: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); 
            // The splash screen will be managed by initializeFirebase after anonymous login.

            // Navigation setup
            const views = {
                'dashboard': 'dashboard-view',
                'contacts': 'contacts-view',
                'team': 'team-view',
                'projections': 'projections-view'
            };

            function showView(viewName) {
                 const isAllowed = window.isAdmin || (viewName === 'team' || viewName === 'contacts');
                
                if (!isAllowed) {
                    // Non-admin trying to access Dashboard or Projections
                    viewName = 'team';
                }

                Object.values(views).forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById(views[viewName]).classList.remove('hidden');

                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active', 'bg-blue-600'));
                
                const navElement = document.getElementById(`nav-${viewName}`);
                if (navElement) {
                     navElement.classList.add('active', 'bg-blue-600');
                }
                
                if (viewName === 'team') window.renderTeamView();
                if (viewName === 'projections') window.updateHistoryChart();
            }

            document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showView('dashboard'); });
            document.getElementById('nav-contacts').addEventListener('click', (e) => { e.preventDefault(); showView('contacts'); });
            document.getElementById('nav-team').addEventListener('click', (e) => { e.preventDefault(); showView('team'); });
            document.getElementById('nav-projections').addEventListener('click', (e) => { e.preventDefault(); showView('projections'); });

        });
    </script>
</body>
</html>
