<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó≥Ô∏è Campagne √âlectorale Consulaires 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active {
            background-color: #3b82f6;
            color: white;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .controlled-message {
            position: fixed; /* Chang√© de absolute √† fixed pour une meilleure visibilit√© */
            bottom: 20px; /* Positionn√© en bas */
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px; 
            border-radius: 0.5rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            z-index: 1000;
        }
        .controlled-message.show {
            opacity: 1;
        }
        .toast-success {
            background-color: #10b981;
            color: white;
        }
        .toast-error {
            background-color: #ef4444;
            color: white;
        }
        .team-table-row:nth-child(even) {
            background-color: #f9fafb;
        }
    </style>
</head>
<body>
    <div id="app-container" class="min-h-screen">
        
        <!-- HEADER ET NAVIGATION -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-900">
                    Campagne √âlectorale Consulaires 2026
                </h1>
                <div id="auth-status" class="flex items-center space-x-3">
                    <span id="user-info" class="text-sm text-gray-600 hidden">
                        Connect√©: <span id="user-display-name" class="font-medium"></span>
                        <span id="user-role" class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"></span>
                    </span>
                    <button id="team-logout-btn" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition duration-150 ease-in-out shadow-sm hidden">D√©connexion</button>
                    <button id="bootstrap-add-member-btn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition duration-150 ease-in-out shadow-sm">Cr√©er √âquipe</button>
                    <button id="splash-team-login-btn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium rounded-lg transition duration-150 ease-in-out shadow-sm">Connexion √âquipe</button>
                </div>
            </div>
        </header>

        <nav id="main-nav" class="bg-gray-800 shadow-lg hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-start h-12 space-x-4">
                    <a href="#" data-view="dashboard" id="nav-dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-150 ease-in-out" aria-current="page">Tableau de Bord</a>
                    <a href="#" data-view="contacts" id="nav-contacts" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150 ease-in-out">Gestion des Contacts</a>
                    <a href="#" data-view="team" id="nav-team" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-150 ease-in-out">√âquipe</a>
                    <a href="#" data-view="projections" id="nav-projections" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-150 ease-in-out">Projections</a>
                </div>
            </div>
        </nav>

        <!-- CONTENU PRINCIPAL -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div id="view-container">
                <!-- VUE SPLASH SCREEN / LOGIN (D√©faut) -->
                <div id="splash-view" class="view" style="display: none;">
                    <div class="kpi-card text-center max-w-lg mx-auto mt-16">
                        <h2 class="text-2xl font-bold mb-4 text-gray-900">Bienvenue dans la Campagne 2026</h2>
                        <p class="text-gray-600 mb-6">Veuillez vous connecter ou cr√©er une nouvelle √©quipe pour commencer.</p>
                        <div class="space-y-4">
                            <button onclick="handleBootstrapClick()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-150 ease-in-out shadow-md">
                                <i class="fas fa-users mr-2"></i> Cr√©er une Nouvelle √âquipe (Bootstrap)
                            </button>
                            <button onclick="handleTeamLogin()" class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition duration-150 ease-in-out shadow-md">
                                <i class="fas fa-sign-in-alt mr-2"></i> Se Connecter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VUE GESTION DES CONTACTS -->
                <div id="contacts-view" class="view" style="display: none;">
                    <div class="kpi-card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-900">Gestion G√©n√©rale des Contacts (Synchro Sheets)</h2>
                            <button id="sync-info-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-150 ease-in-out shadow-md">
                                Info Synchro Sheets
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Ces donn√©es proviennent de la base de donn√©es synchronis√©e.</p>

                        <div class="mb-4">
                            <input type="text" id="search-contacts" placeholder="Rechercher par nom, pr√©nom, email..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>

                        <div id="contacts-status" class="text-center py-8 text-lg font-medium text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Chargement des contacts depuis Firestore...
                        </div>

                        <div id="contacts-table-container" class="overflow-x-auto mt-6 hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NOM (USAGE)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PR√âNOMS</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE NAISS.</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EMAIL</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√âL√âPHONE/WHATSAPP</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUT</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RESPONSABLE</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="contacts-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Les lignes de contact seront ins√©r√©es ici par JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-contacts-message" class="text-center py-4 text-sm text-gray-500 hidden">
                             Aucun contact trouv√©. Les donn√©es seront synchronis√©es depuis Sheets.
                        </div>
                    </div>
                </div>

                <!-- VUE TABLEAU DE BORD -->
                <div id="dashboard-view" class="view" style="display: none;">
                    <h2 class="text-2xl font-bold">Tableau de Bord</h2>
                    <div class="kpi-card mt-4">
                        <p>Contenu du Tableau de Bord... (Statistiques)</p>
                    </div>
                </div>
                
                <!-- VUE GESTION D'√âQUIPE -->
                <div id="team-view" class="view" style="display: none;">
                    <div class="kpi-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-gray-900">Gestion de l'√âquipe (Simul√©)</h3>
                            <select id="admin-team-member-select" class="px-3 py-1 border border-gray-300 rounded-lg text-sm hidden">
                                <option value="all">Tous les Membres</option>
                            </select>
                        </div>
                        
                        <!-- Liste des membres d'√©quipe -->
                        <div id="team-list-container" class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Utilisateur</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">R√¥le</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="team-list" class="bg-white divide-y divide-gray-200">
                                    <tr id="team-loading-row"><td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Chargement de l'√©quipe...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Formulaire d'ajout de membre d'√©quipe -->
                        <div id="add-member-form-container" class="mt-8 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-semibold mb-2">Ajouter un Membre (Simul√©)</h3>
                            <form id="add-team-member-form" class="space-y-4">
                                <input type="text" id="member-name" placeholder="Nom du membre (Affichage)" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <input type="email" id="member-email" placeholder="Email (Utilis√© pour la connexion)" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <select id="member-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="user">Collaborateur</option>
                                    <option value="admin">Administrateur</option>
                                </select>
                                <button type="submit" id="add-team-member-btn" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg">Ajouter Membre (Simul√©)</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- VUE PROJECTIONS -->
                <div id="projections-view" class="view" style="display: none;">
                    <h2 class="text-2xl font-bold">Projections</h2>
                    <div class="kpi-card mt-4">
                        <p>Contenu des Projections (Analyses Pr√©dictives)...</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL POUR LES MESSAGES (Alert/Confirmation Rempla√ßant) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm m-4 transform transition-all">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-4">Message</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-6">Contenu du message ici.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition duration-150 ease-in-out hidden">Annuler</button>
                <button id="modal-confirm" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-150 ease-in-out">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Message pour notifications -->
    <div id="toast-message" class="controlled-message toast-success fixed"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // D√©commenter pour le d√©bogage

        // --- GLOBAL STATE ---
        let app;
        let db;
        let auth;
        let userId = null;
        let userRole = 'guest'; 
        let contactsData = []; // AJOUT√â : Variable globale pour stocker les contacts de Firestore
        let teamMembers = []; // POUR LA VUE √âQUIPE
        const views = ['dashboard', 'contacts', 'team', 'projections'];
        
        const $ = id => document.getElementById(id);

        // --- UTILS ---
        const showToast = (message, type = 'success') => {
            const toast = $('toast-message');
            toast.textContent = message;
            toast.className = `controlled-message toast-${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };
        
        const showModal = (title, message, isConfirm = false) => {
            return new Promise(resolve => {
                const modal = $('message-modal');
                const titleEl = $('modal-title');
                const messageEl = $('modal-message');
                const confirmBtn = $('modal-confirm');
                const cancelBtn = $('modal-cancel');

                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.remove('hidden');

                if (isConfirm) {
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }

                const confirmHandler = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                const cancelHandler = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                confirmBtn.addEventListener('click', confirmHandler);
                if (isConfirm) {
                    cancelBtn.addEventListener('click', cancelHandler);
                }
            });
        };

        // --- CHEMINS FIREBASE ---
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Chemin public pour les donn√©es synchronis√©es (Contacts)
        const getContactsCollectionPath = () => `artifacts/${getAppId()}/public/data/contacts`;
        // Chemin priv√© pour les donn√©es d'√©quipe
        const getTeamCollectionPath = (uid) => `artifacts/${getAppId()}/users/${uid}/team_members`; 

        // --- AUTHENTIFICATION ET INITIALISATION FIREBASE ---

        const fetchUserRole = async (uid) => {
            // Logique simplifi√©e: si l'ID utilisateur contient l'appId, on le consid√®re admin (pour l'environnement canvas)
            if (uid && uid.includes(getAppId())) {
                window.isAdmin = true;
                return 'admin';
            }
            window.isAdmin = false;
            return 'user';
        }

        const initializeFirebase = async () => {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userRole = await fetchUserRole(userId);
                        
                        $('user-display-name').textContent = userId.substring(0, 8) + '...';
                        $('user-role').textContent = userRole.toUpperCase();
                        
                        $('splash-view').style.display = 'none';
                        $('main-nav').classList.remove('hidden');
                        $('user-info').classList.remove('hidden');
                        $('team-logout-btn').classList.remove('hidden');
                        $('bootstrap-add-member-btn').classList.add('hidden');
                        $('splash-team-login-btn').classList.add('hidden');

                        // D√âMARRER LA SOUSCRIPTION AUX CONTACTS APR√àS AUTHENTIFICATION
                        subscribeToContacts();
                        
                        // Afficher la vue par d√©faut
                        const defaultView = window.isAdmin ? 'dashboard' : 'contacts';
                        switchView(defaultView);
                        
                    } else {
                        userId = null;
                        userRole = 'guest';
                        window.isAdmin = false;
                        $('splash-view').style.display = 'block';
                        $('main-nav').classList.add('hidden');
                        $('user-info').classList.add('hidden');
                        $('team-logout-btn').classList.add('hidden');
                        $('bootstrap-add-member-btn').classList.remove('hidden');
                        $('splash-team-login-btn').classList.remove('hidden');
                        switchView('splash');
                    }
                });

            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase ou de l'authentification:", error);
                showToast("Erreur de connexion √† la base de donn√©es. Voir console.", 'error');
            }
        };

        // --- GESTION DES DONN√âES FIREBASE (CONTACTS) ---

        /**
         * √âcoute en temps r√©el la collection de contacts (chemin public).
         */
        const subscribeToContacts = () => {
            if (!db) {
                console.error("Firestore non initialis√©. Impossible de souscrire aux contacts.");
                return;
            }
            
            const contactsRef = collection(db, getContactsCollectionPath());
            
            // onSnapshot √©coute les changements en temps r√©el
            onSnapshot(contactsRef, (snapshot) => {
                const newContacts = [];
                snapshot.forEach((doc) => {
                    // JSON.parse pour les champs potentiellement s√©rialis√©s
                    const data = doc.data();
                    const processedData = {};
                    for (const key in data) {
                        try {
                            // Tentative de parser si la valeur est une cha√Æne JSON valide
                            processedData[key] = JSON.parse(data[key]);
                        } catch (e) {
                            // Si ce n'est pas un JSON, on garde la valeur brute
                            processedData[key] = data[key]; 
                        }
                    }
                    newContacts.push({ id: doc.id, ...processedData });
                });
                
                contactsData = newContacts; // Mise √† jour de la variable globale
                
                console.log(`[Firestore] ${contactsData.length} contacts charg√©s en temps r√©el.`);
                showToast(`${contactsData.length} contacts charg√©s/mis √† jour.`, 'success');

                // Mettre √† jour le tableau
                updateContactsTable();
            }, (error) => {
                console.error("Erreur lors de la lecture des contacts depuis Firestore:", error);
                showToast("Erreur lors de la lecture des contacts. Les droits d'acc√®s ont peut-√™tre chang√©.", 'error');
            });
        };


        // --- RENDU DU TABLEAU DE CONTACTS ---

        const updateContactsTable = () => {
            const container = $('contacts-table-container');
            const status = $('contacts-status');
            const noContactsMessage = $('no-contacts-message');
            const tableBody = $('contacts-table-body');
            const searchTerm = $('search-contacts').value.toLowerCase();
            
            status.classList.add('hidden'); 

            let filteredContacts = contactsData;

            // 1. Filtrer les contacts
            if (searchTerm) {
                filteredContacts = contactsData.filter(contact => {
                    // Recherche dans Nom, Pr√©noms et Email
                    return (contact['NOM (USAGE)'] && String(contact['NOM (USAGE)']).toLowerCase().includes(searchTerm)) ||
                           (contact['PR√âNOMS'] && String(contact['PR√âNOMS']).toLowerCase().includes(searchTerm)) ||
                           (contact['EMAIL'] && String(contact['EMAIL']).toLowerCase().includes(searchTerm));
                });
            }
            
            // 2. Afficher/Cacher la table
            if (filteredContacts.length === 0) {
                container.classList.add('hidden');
                noContactsMessage.classList.remove('hidden');
                if (searchTerm) {
                    noContactsMessage.textContent = `Aucun contact ne correspond √† la recherche "${searchTerm}".`;
                } else {
                    noContactsMessage.textContent = 'Aucun contact trouv√©. Les donn√©es seront synchronis√©es depuis Sheets.';
                }
            } else {
                container.classList.remove('hidden');
                noContactsMessage.classList.add('hidden');
            }

            // 3. Rendre les lignes du tableau
            tableBody.innerHTML = ''; 
            
            filteredContacts.forEach(contact => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-100 transition duration-100';
                
                const columns = [
                    'NOM (USAGE)', 
                    'PR√âNOMS', 
                    'DATE DE NAISSANCE', 
                    'EMAIL', 
                    'T√âL√âPHONE/WHATSAPP', 
                    'STATUT', 
                    'RESPONSABLE'
                ];
                
                columns.forEach(key => {
                    const cell = row.insertCell();
                    cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800';
                    cell.textContent = contact[key] || '-'; 
                });

                const actionsCell = row.insertCell();
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                actionsCell.innerHTML = `
                    <button class="text-indigo-600 hover:text-indigo-900 mr-3" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-600 hover:text-red-900" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            });
        };
        
        // --- RENDU DU TABLEAU D'√âQUIPE (SIMUL√â) ---

        const updateTeamView = () => {
            const teamListBody = $('team-list');
            teamListBody.innerHTML = '';
            
            // Simuler l'ajout de l'utilisateur actuel pour la d√©mo
            let currentTeamMembers = [...teamMembers];
            if (userId && !currentTeamMembers.some(m => m.id === userId)) {
                 currentTeamMembers.unshift({ id: userId, name: 'Moi (Actuel)', email: 'N/A', role: userRole });
            }

            if (currentTeamMembers.length === 0) {
                teamListBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Aucun membre d\'√©quipe trouv√©.</td></tr>';
                return;
            }

            currentTeamMembers.forEach(member => {
                const isCurrentUser = member.id === userId;
                const row = teamListBody.insertRow();
                row.className = 'team-table-row';
                
                row.insertCell().innerHTML = `
                    <span class="font-mono text-xs bg-gray-100 p-1 rounded">
                        ${member.id.substring(0, 12)}${member.id.length > 12 ? '...' : ''}
                    </span>
                    ${isCurrentUser ? '<span class="ml-2 text-xs font-semibold text-blue-600">(Vous)</span>' : ''}
                `;
                
                row.insertCell().innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${member.role === 'admin' ? 'bg-green-100 text-green-800' : 'bg-indigo-100 text-indigo-800'}">
                    ${member.role.charAt(0).toUpperCase() + member.role.slice(1)}
                </span>`;
                
                const actionsCell = row.insertCell();
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                if (window.isAdmin && !isCurrentUser) {
                    actionsCell.innerHTML = `
                        <button onclick="handleRoleChange('${member.id}', '${member.role}')" class="text-blue-600 hover:text-blue-900 mr-3" title="Changer R√¥le">
                            <i class="fas fa-user-shield"></i>
                        </button>
                        <button onclick="handleRemoveMember('${member.id}')" class="text-red-600 hover:text-red-900" title="Retirer">
                            <i class="fas fa-user-minus"></i>
                        </button>
                    `;
                } else {
                     actionsCell.innerHTML = '<span class="text-gray-400">N/A</span>';
                }
            });
        };

        // --- GESTION DES VUES ---

        const switchView = (viewName) => {
            const allViews = document.querySelectorAll('.view');
            allViews.forEach(view => {
                view.style.display = 'none';
            });
            
            const targetView = $(`${viewName}-view`);
            if (targetView) {
                targetView.style.display = 'block';
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active', 'bg-blue-600', 'text-white');
                link.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
            });
            const activeNav = $(`nav-${viewName}`);
            if (activeNav) {
                activeNav.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                activeNav.classList.add('active', 'bg-blue-600', 'text-white');
            }
        };

        // --- GESTION DES √âV√âNEMENTS (SIMULATIONS) ---

        const handleBootstrapClick = async () => {
            const result = await showModal("Cr√©ation d'√âquipe", "Simule la cr√©ation d'une nouvelle √©quipe. √ätes-vous s√ªr ? (Cette action d√©marrerait la proc√©dure d'inscription)", true);
            if (result) {
                showToast("√âquipe cr√©√©e ! (Fonctionnalit√© compl√®te non impl√©ment√©e)", 'success');
            }
        };

        const handleTeamLogin = async () => {
             const result = await showModal("Connexion √âquipe", "Simule la connexion de l'√©quipe. L'authentification r√©elle se fait automatiquement par Canvas.", false);
             if (result) {
                showToast("Tentative de connexion en cours...", 'success');
             }
        };

        const handleLogout = async () => {
             const result = await showModal("D√©connexion", "√ätes-vous s√ªr de vouloir vous d√©connecter ?", true);
             if (result) {
                 if (auth) {
                    signOut(auth);
                    showToast("D√©connexion r√©ussie.", 'success');
                 }
             }
        };
        
        const handleSyncInfoClick = () => {
            showModal(
                "Information de Synchronisation", 
                "Les contacts sont import√©s depuis Google Sheets via Google Apps Script. Ils sont stock√©s dans la collection **'contacts'** du chemin **public** de Firestore. L'application utilise une √©coute en temps r√©el (`onSnapshot`) pour les afficher."
            );
        };
        
        const handleAddTeamMember = async (e) => {
            e.preventDefault();
            
            if (!db || !userId) {
                showToast("Erreur: Non connect√© √† la base de donn√©es.", 'error');
                return;
            }

            const memberName = $('member-name').value;
            const memberEmail = $('member-email').value;
            const memberRole = $('member-role').value;

            showToast(`Membre ${memberName} ajout√©. (Simul√©)`, 'success');
            document.getElementById('add-team-member-form').reset();
            
            const newMemberId = crypto.randomUUID();
            teamMembers.push({ id: newMemberId, name: memberName, email: memberEmail, role: memberRole });
            updateTeamView();
        };

        // Fonctions de gestion de l'√©quipe (Globales pour pouvoir √™tre appel√©es depuis le HTML g√©n√©r√©)
        window.handleRoleChange = async (memberId, currentRole) => {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            const result = await showModal("Changer le R√¥le", `Passer le membre ${memberId.substring(0, 8)}... au r√¥le de "${newRole.toUpperCase()}" ?`, true);
            if (result) {
                showToast(`R√¥le de ${memberId.substring(0, 8)}... chang√© en ${newRole.toUpperCase()} (Simul√©)`, 'success');
                teamMembers = teamMembers.map(m => m.id === memberId ? { ...m, role: newRole } : m);
                updateTeamView();
            }
        };

        window.handleRemoveMember = async (memberId) => {
            const result = await showModal("Retirer Membre", `Voulez-vous retirer le membre ${memberId.substring(0, 8)}... de l'√©quipe ?`, true);
            if (result) {
                showToast(`Membre ${memberId.substring(0, 8)}... retir√© (Simul√©)`, 'success');
                teamMembers = teamMembers.filter(m => m.id !== memberId);
                updateTeamView();
            }
        };

        // --- INITIALISATION GLOBALE ---

        const setupEventListeners = () => {
            const navLinks = document.querySelectorAll('#main-nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.currentTarget.dataset.view);
                });
            });

            $('bootstrap-add-member-btn').addEventListener('click', handleBootstrapClick);
            $('splash-team-login-btn').addEventListener('click', handleTeamLogin);
            
            $('team-logout-btn').addEventListener('click', handleLogout);
            
            // Correction : L'ID du bouton est 'add-team-member-btn', non le formulaire
            $('add-team-member-form').addEventListener('submit', handleAddTeamMember); 
            
            $('sync-info-btn').addEventListener('click', handleSyncInfoClick);
            
            $('search-contacts').addEventListener('input', updateContactsTable);

            // G√®re le changement dans le s√©lecteur d'administrateur
            $('admin-team-member-select').addEventListener('change', updateTeamView);
        };


        window.onload = () => {
            initializeFirebase(); 
            setupEventListeners();
            
            // Initialisation de l'√©quipe pour la d√©mo
            teamMembers = [
                { id: 'admin-simule-123456', name: 'Admin Principal', email: 'admin@example.com', role: 'admin' },
                { id: 'user-simule-987654', name: 'Collaborateur A', email: 'user1@example.com', role: 'user' }
            ];
            updateTeamView(); // Met √† jour la vue √âquipe avec les membres simul√©s
        };
    </script>
</body>
</html>
