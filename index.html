<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó≥Ô∏è Campagne √âlectorale Consulaires 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Configuration et importations Firebase (doit √™tre de type module) -->
    <script type="module">
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Uncomment to see Firebase logs

        // Global instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let usersData = [];
        let contactsData = [];
        let historyData = [];

        // Global App State
        window.isAdmin = false;
        window.userName = '';
        window.memberId = '';

        // Utility function for simpler DOM access
        const $ = (id) => document.getElementById(id);

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        function initializeFirebase() {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing. The app will run without real-time database features.");
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    userId = user.uid;
                } else {
                    // User is signed out, sign in with custom token or anonymously
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Only sign in anonymously if no token is available
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error during initial authentication:", error);
                    }
                }
                // Once auth state is set, we can listen to the public data
                isAuthReady = true;
                if (db) {
                    setupDataListeners();
                }
            });
        }

        // --- FIREBASE LISTENERS (Snapshot) ---
        function setupDataListeners() {
            if (!isAuthReady || !db) return;

            // Define collections paths (Public for all to read/write)
            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
            const contactsCollectionRef = collection(db, `artifacts/${appId}/public/data/contacts`);
            const historyCollectionRef = collection(db, `artifacts/${appId}/public/data/history`);


            // Listener for USERS (Team Members)
            onSnapshot(usersCollectionRef, (snapshot) => {
                usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // If the app is in the splash screen, update the member list
                if (!$('app-container').classList.contains('hidden')) {
                    updateTeamDropdown(usersData);
                    // Check if the current user still exists and update admin status if needed
                    checkLoginStatus();
                } else {
                    // If the user is logged in, redraw the team view and navigation
                    checkLoginStatus(); 
                    renderTeamView(usersData, contactsData);
                }
                
                // If there are no users, force bootstrap mode
                if (usersData.length === 0) {
                    showSplashScreen('bootstrap');
                } else if ($('splash-screen').dataset.mode === 'bootstrap') {
                    // If we just added the first user, switch to standard login
                    showSplashScreen('login');
                }
            }, (error) => console.error("Error fetching users:", error));

            // Listener for CONTACTS
            onSnapshot(contactsCollectionRef, (snapshot) => {
                contactsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!$('splash-screen').classList.contains('hidden')) return; // Only update if logged in
                
                // Rerender all views dependent on contacts
                renderDashboard(contactsData);
                renderContactsView(contactsData);
                renderTeamView(usersData, contactsData);
            }, (error) => console.error("Error fetching contacts:", error));

            // Listener for HISTORY
            onSnapshot(historyCollectionRef, (snapshot) => {
                historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.timestamp - b.timestamp);
                if (!$('splash-screen').classList.contains('hidden')) return;
                renderProjectionsView(contactsData, historyData);
            }, (error) => console.error("Error fetching history:", error));
        }

        // --- AUTH/STATE MANAGEMENT ---

        function checkLoginStatus() {
            const loggedInUser = usersData.find(u => u.id === window.memberId);

            if (loggedInUser) {
                window.isAdmin = loggedInUser.role === 'admin';
                window.userName = loggedInUser.name;

                $('user-info-name').textContent = window.userName;
                $('user-info-status').textContent = window.isAdmin ? 'Admin' : 'Membre';
                $('user-info-status').className = window.isAdmin 
                    ? 'font-bold text-sm px-3 py-1 bg-red-100 text-red-700 rounded-full' 
                    : 'font-bold text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded-full';
                
                // Update navigation visibility
                updateNavigation();
                
                // Ensure correct view is displayed based on permissions
                const currentView = document.querySelector('#main-content > div:not(.hidden)').id.replace('-view', '');
                if (currentView === 'dashboard' && !window.isAdmin) {
                    switchView('contacts'); // Default to contacts if not admin
                } else if (currentView === 'projections' && !window.isAdmin) {
                    switchView('contacts'); // Default to contacts if not admin
                }

            } else if (window.memberId) {
                 // Member was logged in but no longer exists in usersData (e.g., deleted by admin)
                handleLogout();
            }
        }
        
        function updateNavigation() {
            // Control visibility of Admin-only links
            document.querySelectorAll('[data-admin-only]').forEach(el => {
                el.classList.toggle('hidden', !window.isAdmin);
            });
        }

        function showSplashScreen(mode = 'login') {
            $('splash-screen').classList.remove('hidden');
            $('app-container').classList.add('hidden');
            $('splash-screen').dataset.mode = mode;

            $('login-form').classList.toggle('hidden', mode === 'bootstrap');
            $('bootstrap-form').classList.toggle('hidden', mode === 'login');
            
            if (mode === 'login') {
                 // Populate team dropdown for login
                updateTeamDropdown(usersData);
            }
        }

        function handleLogin(memberId, userName, isAdmin) {
            window.memberId = memberId;
            window.userName = userName;
            window.isAdmin = isAdmin;
            
            // Hide splash, show app
            $('splash-screen').classList.add('hidden');
            $('app-container').classList.remove('hidden');

            // Update user info in header
            $('user-info-id').textContent = userId.substring(0, 8); // Firebase UID
            $('user-info-name').textContent = userName;
            $('user-info-status').textContent = isAdmin ? 'Admin' : 'Membre';
            $('user-info-status').className = isAdmin 
                ? 'font-bold text-sm px-3 py-1 bg-red-100 text-red-700 rounded-full' 
                : 'font-bold text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded-full';

            // Show default view
            const defaultView = window.isAdmin ? 'dashboard' : 'contacts';
            updateNavigation();
            switchView(defaultView);
        }

        async function handleLogout() {
            try {
                // Clear local state
                window.memberId = '';
                window.userName = '';
                window.isAdmin = false;
                
                // Reset to splash screen
                showSplashScreen('login'); 
                
            } catch(e) {
                console.error("Error during logout:", e);
                // Even on error, still reset local state and UI
                showSplashScreen('login');
            }
        }

        // --- NAVIGATION ---
        function switchView(viewName) {
            const views = ['dashboard', 'contacts', 'team', 'projections'];
            const navLinks = document.querySelectorAll('#main-nav a');
            
            // Hide all views
            views.forEach(view => $(`${view}-view`).classList.add('hidden'));

            // Show the selected view
            const selectedView = $(`${viewName}-view`);
            if (selectedView) {
                selectedView.classList.remove('hidden');
            } else {
                console.error(`View ${viewName} not found.`);
                return;
            }

            // Update active link styling
            navLinks.forEach(link => link.classList.remove('active', 'bg-blue-600', 'text-white'));
            const activeLink = document.querySelector(`[data-view="${viewName}"]`);
            if (activeLink) {
                activeLink.classList.add('active', 'bg-blue-600', 'text-white');
            }

            // Trigger specific view renders on switch
            if (viewName === 'dashboard') renderDashboard(contactsData);
            if (viewName === 'contacts') renderContactsView(contactsData);
            if (viewName === 'team') renderTeamView(usersData, contactsData);
            if (viewName === 'projections') renderProjectionsView(contactsData, historyData);
        }

        // --- SPLASH SCREEN LOGIC (Login/Bootstrap) ---

        function updateTeamDropdown(members) {
            const select = $('team-member-select');
            select.innerHTML = '<option value="" disabled selected>S√©lectionner votre nom</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                select.appendChild(option);
            });
        }

        async function handleBootstrapClick() {
            const name = $('bootstrap-name-input').value.trim();
            const secret = $('bootstrap-secret-input').value.trim();
            
            if (!name || !secret) {
                alertUser('Veuillez entrer votre nom et une cl√© secr√®te.');
                return;
            }

            // Determine role: Admin if name is "Damien" (as per instructions)
            const role = name.toLowerCase() === 'damien' ? 'admin' : 'member';
            
            try {
                // Check if this member already exists in the local copy (which should be up-to-date via snapshot)
                if (usersData.some(u => u.name.toLowerCase() === name.toLowerCase())) {
                     alertUser('Ce nom est d√©j√† utilis√©. Veuillez vous connecter.');
                     return;
                }
                
                // Add the new member
                const newUserRef = doc(collection(db, `artifacts/${appId}/public/data/users`)); // Firestore generates the ID
                await setDoc(newUserRef, { 
                    name: name,
                    secretKey: secret, // NOTE: Not hashed for simplicity, but should be in a real app
                    role: role,
                    createdAt: Date.now()
                });
                
                alertUser(`Bienvenue ${name} ! Votre compte ${role.toUpperCase()} a √©t√© cr√©√©.`);
                
                // Log in the newly created user (using the generated ID)
                handleLogin(newUserRef.id, name, role === 'admin');
                
            } catch (error) {
                console.error("Error creating bootstrap user:", error);
                alertUser('Erreur lors de la cr√©ation du compte. Veuillez r√©essayer.');
            }
        }

        async function handleTeamLogin() {
            const memberId = $('team-member-select').value;
            const secret = $('splash-login-secret-input').value.trim();
            
            if (!memberId || !secret) {
                alertUser('Veuillez s√©lectionner votre nom et entrer la cl√© secr√®te.');
                return;
            }
            
            const member = usersData.find(u => u.id === memberId);

            if (!member) {
                 alertUser('Membre non trouv√©.');
                 return;
            }

            if (member.secretKey === secret) {
                handleLogin(member.id, member.name, member.role === 'admin');
            } else {
                 alertUser('Cl√© secr√®te incorrecte.');
            }
        }

        // --- TEAM MANAGEMENT VIEW LOGIC ---

        function generateSecretKey() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        async function handleAddTeamMember() {
            const name = $('new-member-name').value.trim();
            const role = $('new-member-role').value;
            
            if (!name) {
                alertUser('Veuillez entrer le nom du nouveau membre.');
                return;
            }

            const secretKey = generateSecretKey();

            try {
                // Check if member already exists (simple check by name)
                if (usersData.some(u => u.name.toLowerCase() === name.toLowerCase())) {
                     alertUser('Un membre avec ce nom existe d√©j√†.');
                     return;
                }
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/users`), {
                    name: name,
                    secretKey: secretKey,
                    role: role,
                    createdAt: Date.now()
                });

                $('new-member-name').value = '';
                alertUser(`Membre ${name} ajout√© ! Cl√© secr√®te: ${secretKey}`);

            } catch (error) {
                console.error("Error adding team member:", error);
                alertUser('Erreur lors de l\'ajout du membre.');
            }
        }

        async function handleDeleteMember(memberId) {
             if (window.memberId === memberId) {
                 alertUser('Vous ne pouvez pas vous supprimer vous-m√™me !');
                 return;
            }
            
            if (window.confirm('√ätes-vous s√ªr de vouloir supprimer ce membre ?')) { // NOTE: Custom modal should be used instead of window.confirm
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, memberId));
                    alertUser('Membre supprim√© avec succ√®s.');
                } catch (error) {
                    console.error("Error deleting member:", error);
                    alertUser('Erreur lors de la suppression du membre.');
                }
            }
        }


        function renderTeamView(members, contacts) {
            const teamListContainer = $('team-list-container');
            const assignDropdown = $('assign-contact-dropdown');
            const contactsAssignedList = $('contacts-assigned-list');
            
            if (!teamListContainer || !contactsAssignedList) return;

            // Admin Management Section
            if (window.isAdmin) {
                $('admin-team-management').classList.remove('hidden');
                
                teamListContainer.innerHTML = members.map(member => `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm mb-2 border-l-4 ${member.role === 'admin' ? 'border-red-500' : 'border-blue-500'}">
                        <div class="flex-grow">
                            <p class="font-semibold text-lg">${member.name}</p>
                            <p class="text-sm text-gray-500">Cl√©: <span class="font-mono text-gray-800">${member.secretKey}</span></p>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${member.role === 'admin' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">${member.role === 'admin' ? 'ADMIN' : 'MEMBRE'}</span>
                        </div>
                        <div>
                            ${member.id !== window.memberId ? `<button onclick="window.handleDeleteMember('${member.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>` : ''}
                        </div>
                    </div>
                `).join('');
                
                // Populate Admin contact viewing dropdown
                assignDropdown.innerHTML = `<option value="${window.memberId}">Mes Contacts (${window.userName})</option>` + members.map(member => `
                    <option value="${member.id}">${member.name}</option>
                `).join('');
                assignDropdown.value = assignDropdown.dataset.selected || window.memberId;
                assignDropdown.classList.remove('hidden');
                
            } else {
                $('admin-team-management').classList.add('hidden');
                assignDropdown.classList.add('hidden');
            }
            
            // Render Assigned Contacts
            const selectedMemberId = assignDropdown.dataset.selected || window.memberId;
            const contactsToDisplay = contacts.filter(c => c.responsibleId === selectedMemberId);
            const selectedMemberName = members.find(m => m.id === selectedMemberId)?.name || "Non Assign√©";
            
            $('contacts-assigned-title').textContent = window.isAdmin && selectedMemberId !== window.memberId 
                ? `Contacts Assign√©s √† ${selectedMemberName}` 
                : 'Mes Contacts Assign√©s';
                
            if (contactsToDisplay.length === 0) {
                 contactsAssignedList.innerHTML = `<p class="text-center text-gray-500 p-6 bg-white rounded-lg shadow-inner">Aucun contact assign√©.</p>`;
                 return;
            }

             contactsAssignedList.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom Pr√©nom</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√©l√©phone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vot√© (Jour J)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${contactsToDisplay.map(c => {
                            const statusColor = getStatusColor(c.status);
                            return `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.lastName} ${c.firstName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.phone || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor.bg} ${statusColor.text}">
                                            ${c.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                         <input type="checkbox" data-contact-id="${c.id}" ${c.voted ? 'checked' : ''} onchange="window.toggleVotedStatus(this)"
                                            class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="window.editContact('${c.id}')" class="text-indigo-600 hover:text-indigo-900 ml-2">√âditer</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            // Re-attach event listener for the Admin dropdown
            assignDropdown.onchange = (e) => {
                assignDropdown.dataset.selected = e.target.value;
                renderTeamView(usersData, contactsData);
            };
        }
        
        // Expose to global scope for inline events
        window.handleDeleteMember = handleDeleteMember;
        window.toggleVotedStatus = toggleVotedStatus;
        window.editContact = editContact;
        

        // --- CONTACTS VIEW LOGIC (Admin/Member) ---
        
        // Helper to get contact status color
        function getStatusColor(status) {
            switch(status) {
                case 'Acquis': return { bg: 'bg-green-100', text: 'text-green-800' };
                case 'Probable': return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
                case 'R√©ticent': return { bg: 'bg-orange-100', text: 'text-orange-800' };
                case 'Refus': return { bg: 'bg-red-100', text: 'text-red-800' };
                case '√Ä contacter':
                default: return { bg: 'bg-gray-100', text: 'text-gray-800' };
            }
        }
        
        // Helper to find responsible name
        function getResponsibleName(responsibleId) {
            return usersData.find(u => u.id === responsibleId)?.name || 'Non Assign√©';
        }
        
        let currentContactFilter = '';

        function renderContactsView(contacts) {
            const tableBody = $('contacts-table-body');
            const filterText = currentContactFilter.toLowerCase();
            
            // Only admins see all contacts; members only see unassigned contacts or their assigned contacts.
            // For simplicity in this demo, all contacts are shown to members too if they are not assigned.
            const contactsToDisplay = contacts.filter(c => 
                 window.isAdmin || c.responsibleId === window.memberId || !c.responsibleId // Show all unassigned or own assigned to member
            ).filter(c => 
                !filterText || 
                c.firstName.toLowerCase().includes(filterText) || 
                c.lastName.toLowerCase().includes(filterText) || 
                c.email.toLowerCase().includes(filterText) || 
                c.status.toLowerCase().includes(filterText) ||
                getResponsibleName(c.responsibleId).toLowerCase().includes(filterText)
            ).sort((a, b) => a.lastName.localeCompare(b.lastName));

            if (contactsToDisplay.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">Aucun contact trouv√©.</td></tr>`;
                 return;
            }

            tableBody.innerHTML = contactsToDisplay.map(contact => {
                const statusColor = getStatusColor(contact.status);
                const responsibleName = getResponsibleName(contact.responsibleId);
                
                return `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${contact.lastName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.firstName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact.phone || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor.bg} ${statusColor.text}">
                                ${contact.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                             ${window.isAdmin ? `<select class="p-1 border rounded" data-contact-id="${contact.id}" onchange="window.assignContact(this)">
                                ${usersData.map(u => `<option value="${u.id}" ${contact.responsibleId === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                <option value="" ${!contact.responsibleId ? 'selected' : ''}>[Non Assign√©]</option>
                            </select>` : responsibleName}
                        </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="window.editContact('${contact.id}')" class="text-indigo-600 hover:text-indigo-900 ml-2">√âditer</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Function to update responsibleId of a contact
        async function assignContact(selectElement) {
            const contactId = selectElement.dataset.contactId;
            const newResponsibleId = selectElement.value === '' ? null : selectElement.value; // Use null for unassigned
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/contacts`, contactId), {
                    responsibleId: newResponsibleId
                });
                alertUser('Contact assign√© !');
            } catch (error) {
                console.error("Error assigning contact:", error);
                alertUser('Erreur lors de l\'assignation du contact.');
            }
        }
        
        // Function to update voted status from team view
        async function toggleVotedStatus(checkboxElement) {
            const contactId = checkboxElement.dataset.contactId;
            const voted = checkboxElement.checked;
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/contacts`, contactId), {
                    voted: voted,
                    votedBy: voted ? window.memberId : null,
                    votedAt: voted ? Date.now() : null
                });
                alertUser(`Statut de vote mis √† jour: ${voted ? 'VOT√â' : 'NON VOT√â'}`);
            } catch (error) {
                console.error("Error toggling voted status:", error);
                alertUser('Erreur lors de la mise √† jour du statut.');
            }
        }
        
        // Function to open the modal for contact editing/creation
        let editingContactId = null;

        function editContact(contactId = null) {
            const modal = $('contact-modal');
            const contact = contactId ? contactsData.find(c => c.id === contactId) : null;
            editingContactId = contactId;

            if (contact) {
                $('modal-title').textContent = '√âditer Contact';
                $('contact-first-name').value = contact.firstName || '';
                $('contact-last-name').value = contact.lastName || '';
                $('contact-email').value = contact.email || '';
                $('contact-phone').value = contact.phone || '';
                $('contact-status').value = contact.status || '√Ä contacter';
                $('contact-responsible').value = contact.responsibleId || '';
            } else {
                $('modal-title').textContent = 'Ajouter Contact';
                $('contact-form').reset();
                $('contact-responsible').value = window.memberId; // Default to current user
            }
            
            // Populate responsible dropdown
             $('contact-responsible').innerHTML = usersData.map(u => `
                <option value="${u.id}">${u.name}</option>
            `).join('') + `<option value="">[Non Assign√©]</option>`;

            if (contact) {
                 $('contact-responsible').value = contact.responsibleId || '';
            } else {
                 $('contact-responsible').value = window.memberId;
            }

            modal.classList.remove('hidden');
        }
        
        // Function to close the modal
        function closeContactModal() {
            $('contact-modal').classList.add('hidden');
            editingContactId = null;
        }

        // Function to handle form submission (Save/Create)
        async function saveContact() {
            const firstName = $('contact-first-name').value.trim();
            const lastName = $('contact-last-name').value.trim();
            const email = $('contact-email').value.trim();
            const phone = $('contact-phone').value.trim();
            const status = $('contact-status').value;
            const responsibleId = $('contact-responsible').value || null;

            if (!lastName || !firstName) {
                alertUser('Le nom et le pr√©nom sont obligatoires.');
                return;
            }

            const contactData = {
                firstName,
                lastName,
                email,
                phone,
                status,
                responsibleId,
                updatedAt: Date.now()
            };
            
            try {
                if (editingContactId) {
                    // Update existing contact
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/contacts`, editingContactId), contactData);
                    alertUser('Contact mis √† jour !');
                } else {
                    // Create new contact
                    contactData.createdAt = Date.now();
                    contactData.voted = false;
                    await addDoc(collection(db, `artifacts/${appId}/public/data/contacts`), contactData);
                    alertUser('Nouveau contact ajout√© !');
                }
                closeContactModal();
            } catch (error) {
                console.error("Error saving contact:", error);
                alertUser('Erreur lors de la sauvegarde du contact.');
            }
        }
        
        // Function to delete a contact
        async function deleteContact() {
             if (!editingContactId) return;

             if (window.confirm('√ätes-vous s√ªr de vouloir supprimer ce contact ?')) { // NOTE: Custom modal should be used instead of window.confirm
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/contacts`, editingContactId));
                    alertUser('Contact supprim√© avec succ√®s.');
                    closeContactModal();
                } catch (error) {
                    console.error("Error deleting contact:", error);
                    alertUser('Erreur lors de la suppression du contact.');
                }
            }
        }
        
        // Expose to global scope for inline events
        window.assignContact = assignContact;
        window.editContact = editContact;
        window.closeContactModal = closeContactModal;
        window.saveContact = saveContact;
        window.deleteContact = deleteContact;
        
        // Attach event listener for search input
        window.onload = () => {
            initializeFirebase();
            setupEventListeners();
            
            const searchInput = $('contact-search-input');
            if (searchInput) {
                 searchInput.addEventListener('input', (e) => {
                    currentContactFilter = e.target.value;
                    renderContactsView(contactsData);
                });
            }
            
            const addContactButton = $('add-contact-btn');
             if (addContactButton) {
                addContactButton.addEventListener('click', () => editContact(null));
            }
        };

        // --- DASHBOARD VIEW LOGIC (Admin Only) ---
        
        function renderDashboard(contacts) {
            if (!window.isAdmin) {
                $('dashboard-view').classList.add('hidden');
                return;
            }
            
            // 1. Calculate KPIs
            const totalContacts = contacts.length;
            const acquiredVotes = contacts.filter(c => c.status === 'Acquis').length;
            const probableVotes = contacts.filter(c => c.status === 'Probable').length;
            const votedCount = contacts.filter(c => c.voted).length;
            const projectedVotes = acquiredVotes + (probableVotes * 0.5);
            
            const GOAL = 1000;
            const goalPercentage = Math.min(100, (acquiredVotes / GOAL) * 100).toFixed(1);

            // 2. Update KPI Cards
            $('kpi-total-contacts').textContent = totalContacts.toLocaleString('fr-FR');
            $('kpi-acquired-votes').textContent = acquiredVotes.toLocaleString('fr-FR');
            $('kpi-voted-count').textContent = votedCount.toLocaleString('fr-FR');
            $('kpi-projected-votes').textContent = projectedVotes.toFixed(0).toLocaleString('fr-FR');

            // 3. Update Goal Progress
            $('goal-progress-bar').style.width = `${goalPercentage}%`;
            $('goal-progress-text').textContent = `${acquiredVotes.toLocaleString('fr-FR')} / ${GOAL.toLocaleString('fr-FR')} (${goalPercentage}%)`;
            
            // 4. Prepare data for status distribution chart (simple version)
            const statusCounts = contacts.reduce((acc, c) => {
                acc[c.status] = (acc[c.status] || 0) + 1;
                return acc;
            }, {});
            
            const statusOrder = ['Acquis', 'Probable', 'R√©ticent', '√Ä contacter', 'Refus'];
            
            const chartData = statusOrder.map(status => ({
                status: status,
                count: statusCounts[status] || 0
            }));
            
            renderStatusChart('status-chart-container', chartData);

            // 5. Update Birthdays (simple list for the next 30 days)
            renderUpcomingBirthdays(contacts);
        }

        // Simple Chart Rendering (no external library, simple DOM representation)
        function renderStatusChart(containerId, data) {
            const container = $(containerId);
            if (!container) return;
            
            const total = data.reduce((sum, item) => sum + item.count, 0);
            
            container.innerHTML = `
                <div class="flex flex-col space-y-2">
                    ${data.filter(item => item.count > 0).map(item => {
                        const percent = ((item.count / total) * 100).toFixed(0);
                        const color = getStatusColor(item.status).bg.replace('-100', '-500'); // Use a stronger color for the bar
                        return `
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-medium text-gray-700 w-24">${item.status}</span>
                                <div class="flex-grow bg-gray-200 rounded-full h-3">
                                    <div class="h-3 rounded-full ${color}" style="width: ${percent}%;"></div>
                                </div>
                                <span class="text-sm font-semibold w-10 text-right">${item.count}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function renderUpcomingBirthdays(contacts) {
            const birthdayList = $('upcoming-birthdays');
            
            // Format: DD/MM (simple string for this demo, real logic would use Date objects)
            const contactsWithBirthday = contacts.filter(c => c.birthday)
                .map(c => ({
                    name: `${c.firstName} ${c.lastName}`,
                    birthday: c.birthday // Format 'DD/MM'
                }))
                .sort((a, b) => {
                    // Simple string sort, assuming DD/MM format
                    const [dayA, monthA] = a.birthday.split('/').map(Number);
                    const [dayB, monthB] = b.birthday.split('/').map(Number);
                    if (monthA !== monthB) return monthA - monthB;
                    return dayA - dayB;
                });
                
            if (contactsWithBirthday.length === 0) {
                 birthdayList.innerHTML = `<p class="text-gray-500">Aucun anniversaire enregistr√©.</p>`;
                 return;
            }
            
            birthdayList.innerHTML = contactsWithBirthday.slice(0, 5).map(c => `
                <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-700">${c.name}</span>
                    <span class="text-xs font-semibold text-blue-600">${c.birthday}</span>
                </div>
            `).join('');
        }


        // --- PROJECTIONS VIEW LOGIC (Admin Only) ---
        
        function renderProjectionsView(contacts, history) {
            if (!window.isAdmin) {
                $('projections-view').classList.add('hidden');
                return;
            }
            
            // Calculate current votes data
            const acquired = contacts.filter(c => c.status === 'Acquis').length;
            const probable = contacts.filter(c => c.status === 'Probable').length;
            const total = contacts.length;
            
            $('current-acquired').textContent = acquired.toLocaleString('fr-FR');
            $('current-probable').textContent = probable.toLocaleString('fr-FR');
            $('current-total-contacts').textContent = total.toLocaleString('fr-FR');
            
            // Render History Chart (simple bar chart based on history data)
            renderHistoryChart('history-chart-container', history);
        }
        
        function renderHistoryChart(containerId, history) {
            const container = $(containerId);
            if (!container) return;
            
            const historyToDisplay = history.slice(-7); // Last 7 entries
            
            if (historyToDisplay.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-6">Historique vide. Lancez une simulation pour enregistrer des donn√©es.</p>`;
                return;
            }
            
            // Find max value for scaling the bars
            const maxVal = Math.max(...historyToDisplay.map(h => h.projectedVotes));

            container.innerHTML = `
                <div class="flex h-64 items-end space-x-2 border-l border-b border-gray-300 p-2">
                    ${historyToDisplay.map(h => {
                        const heightPercent = maxVal > 0 ? (h.projectedVotes / maxVal) * 90 : 0; // 90% max height
                        const date = new Date(h.timestamp).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
                        return `
                            <div class="flex flex-col items-center flex-grow group relative h-full">
                                <div class="w-full bg-blue-400 rounded-t-lg transition duration-300 hover:bg-blue-600" 
                                     style="height: ${heightPercent}%;">
                                </div>
                                <span class="text-xs text-gray-600 mt-1">${date}</span>
                                <div class="absolute top-0 transform -translate-y-full p-1 text-xs bg-gray-800 text-white rounded opacity-0 group-hover:opacity-100 transition duration-300">
                                    ${h.projectedVotes.toFixed(0)} votes
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <p class="text-center text-sm text-gray-500 mt-2">Projection des votes pond√©r√©s (Historique)</p>
            `;
        }

        async function handleProjection() {
            const totalInscrits = parseInt($('total-inscrits').value, 10);
            const participationRate = parseFloat($('participation-rate').value) / 100;
            const numListes = parseInt($('num-listes').value, 10);
            const seatsGoal = parseInt($('seats-goal').value, 10);

            if (isNaN(totalInscrits) || isNaN(participationRate) || isNaN(numListes) || isNaN(seatsGoal)) {
                 alertUser('Veuillez remplir tous les champs de projection correctement.');
                 return;
            }

            // Current campaign data
            const acquired = contactsData.filter(c => c.status === 'Acquis').length;
            const probable = contactsData.filter(c => c.status === 'Probable').length;
            const projectedVotes = acquired + (probable * 0.5);

            // SIMULATION: How many votes are needed to win a seat (simple quotient method)
            const turnout = totalInscrits * participationRate;
            const quotient = turnout / (seatsGoal + 1); // Simple d'Hondt-like or similar estimate
            const requiredVotes = Math.ceil(quotient / numListes); 

            // Calculate the required percentage of actual votes
            const requiredPercentage = (requiredVotes / turnout) * 100;
            
            // Render Results
            $('sim-turnout').textContent = turnout.toFixed(0).toLocaleString('fr-FR');
            $('sim-required-votes').textContent = requiredVotes.toLocaleString('fr-FR');
            $('sim-required-percentage').textContent = requiredPercentage.toFixed(2) + '%';
            
            const gap = projectedVotes - requiredVotes;
            const gapElement = $('sim-gap');
            gapElement.textContent = gap.toFixed(0).toLocaleString('fr-FR');
            
            if (gap >= 0) {
                gapElement.className = 'text-2xl font-bold text-green-600';
                $('sim-status').textContent = 'Objectif Atteint (SELON PROJECTION)';
                 $('sim-status').className = 'text-green-600 font-semibold';
            } else {
                gapElement.className = 'text-2xl font-bold text-red-600';
                 $('sim-status').textContent = 'Objectif NON Atteint (SELON PROJECTION)';
                 $('sim-status').className = 'text-red-600 font-semibold';
            }
            
            // Save current projection to history
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/history`), {
                    timestamp: Date.now(),
                    projectedVotes: projectedVotes,
                    requiredVotes: requiredVotes,
                    inscrits: totalInscrits,
                    participation: participationRate,
                    lists: numListes,
                    seats: seatsGoal,
                    gap: gap
                });
                alertUser('Simulation enregistr√©e dans l\'historique.');
            } catch (error) {
                 console.error("Error saving projection history:", error);
                 alertUser('Erreur lors de l\'enregistrement de l\'historique.');
            }
        }
        
        // Expose to global scope for inline events
        window.handleProjection = handleProjection;

        // --- GLOBAL UI HELPERS ---
        
        // Simple non-blocking alert system
        let messageTimeout;
        function alertUser(message, type = 'success') {
            const el = $('alert-message');
            const color = type === 'error' ? 'bg-red-500' : 'bg-green-500';

            el.textContent = message;
            el.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${color} z-50 transition-transform duration-300`;
            el.style.transform = 'translateY(0)';
            
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                el.style.transform = 'translateY(150%)';
            }, 3000);
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('#main-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.currentTarget.dataset.view);
                });
            });

            // Splash Screen buttons
            const bootstrapBtn = $('bootstrap-add-member-btn');
            if (bootstrapBtn) bootstrapBtn.addEventListener('click', handleBootstrapClick);
            const loginBtn = $('splash-team-login-btn');
            if (loginBtn) loginBtn.addEventListener('click', handleTeamLogin);
            
            // Main App buttons
            const logoutBtn = $('team-logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            const addMemberBtn = $('add-team-member-btn');
            if (addMemberBtn) addMemberBtn.addEventListener('click', handleAddTeamMember);
            
             // Projection Button
            const projectionBtn = $('run-projection-btn');
            if (projectionBtn) projectionBtn.addEventListener('click', handleProjection);
        }


    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .nav-link.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        /* Style pour l'alerte non-bloquante */
        #alert-message {
            transform: translateY(150%);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Non-blocking Alert Message -->
    <div id="alert-message" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white bg-green-500 z-50 transition-transform duration-300">
        Message d'alerte.
    </div>

    <!-- SPLASH SCREEN (Login/Bootstrap) -->
    <div id="splash-screen" class="min-h-screen flex items-center justify-center bg-gray-100" data-mode="bootstrap">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h1 class="text-4xl font-bold text-center text-blue-600 mb-2">Nouvelle √ânergie</h1>
            <p class="text-center text-gray-500 mb-8">Campagne Consulaires 2026</p>

            <!-- Bootstrap Form (Visible if no users exist) -->
            <div id="bootstrap-form" class="space-y-4">
                <div class="text-center text-sm text-red-500 font-medium p-2 border border-red-200 bg-red-50 rounded-lg">
                    üö® **Mode D√©marrage :** Cr√©ez le premier compte. Entrez **"Damien"** pour les droits Administrateur.
                </div>
                <div>
                    <label for="bootstrap-name-input" class="block text-sm font-medium text-gray-700">Votre Nom</label>
                    <input type="text" id="bootstrap-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Damien">
                </div>
                <div>
                    <label for="bootstrap-secret-input" class="block text-sm font-medium text-gray-700">Cl√© Secr√®te (Minimum 4 caract√®res)</label>
                    <input type="password" id="bootstrap-secret-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="Cl√© de connexion">
                </div>
                <button id="bootstrap-add-member-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                    Cr√©er le Compte et Se Connecter
                </button>
            </div>
            
            <!-- Login Form (Visible if users exist) -->
            <div id="login-form" class="space-y-4 hidden">
                <div>
                    <label for="team-member-select" class="block text-sm font-medium text-gray-700">Votre Nom</label>
                    <select id="team-member-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>S√©lectionner votre nom</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
                <div>
                    <label for="splash-login-secret-input" class="block text-sm font-medium text-gray-700">Cl√© de Connexion Secr√®te</label>
                    <input type="password" id="splash-login-secret-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="Votre cl√© secr√®te">
                </div>
                <button id="splash-team-login-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                    Se Connecter
                </button>
            </div>
        </div>
    </div>
    
    <!-- MAIN APPLICATION CONTAINER -->
    <div id="app-container" class="hidden min-h-screen flex flex-col">
        
        <!-- Header & Navigation -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <span class="text-2xl font-bold text-blue-600">Campagne √âlectorale Consulaires 2026</span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex flex-col items-end text-sm text-gray-700">
                            <span id="user-info-name" class="font-semibold">Utilisateur</span>
                            <span class="text-xs text-gray-500">ID: <span id="user-info-id">N/A</span></span>
                        </div>
                         <span id="user-info-status" class="font-bold text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded-full">Statut</span>
                        <button id="team-logout-btn" class="flex items-center text-red-500 hover:text-red-700 transition duration-150 p-2 rounded-full hover:bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
             <!-- Navigation Bar -->
            <nav class="bg-gray-100 border-t border-gray-200">
                <div id="main-nav" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-2 py-1 overflow-x-auto">
                    <a data-view="dashboard" data-admin-only class="nav-link hidden px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100 text-sm font-medium">Tableau de Bord</a>
                    <a data-view="contacts" class="nav-link active bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Gestion des Contacts</a>
                    <a data-view="team" class="nav-link px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100 text-sm font-medium">√âquipe</a>
                    <a data-view="projections" data-admin-only class="nav-link hidden px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100 text-sm font-medium">Projections</a>
                </div>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow p-4 sm:p-6 lg:p-8">
            
            <!-- 1. DASHBOARD VIEW (Admin Only) -->
            <div id="dashboard-view" class="space-y-8 hidden">
                <h2 class="text-3xl font-extrabold text-gray-900">Tableau de Bord</h2>
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="kpi-card border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Contacts G√©r√©s</p>
                        <p id="kpi-total-contacts" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="kpi-card border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Votes 'Acquis'</p>
                        <p id="kpi-acquired-votes" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="kpi-card border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">A Vot√© (Jour J)</p>
                        <p id="kpi-voted-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="kpi-card border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Votes Projet√©s (Pond√©r√©s)</p>
                        <p id="kpi-projected-votes" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                </div>
                
                <!-- Goal & Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Goal Progress -->
                    <div class="lg:col-span-2 kpi-card space-y-4">
                        <h3 class="text-xl font-semibold text-gray-900">Objectif de Votes 'Acquis' (1000)</h3>
                        <div class="bg-gray-200 rounded-full h-4">
                            <div id="goal-progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="goal-progress-text" class="text-sm font-medium text-gray-700 text-right">0 / 1000 (0.0%)</p>
                    </div>
                    
                    <!-- Upcoming Birthdays -->
                    <div class="kpi-card">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">üéÇ Anniversaires (30 Jours)</h3>
                        <div id="upcoming-birthdays" class="space-y-1">
                            <!-- Birthday items go here -->
                            <p class="text-gray-500">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Status Distribution Chart -->
                <div class="kpi-card">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">R√©partition des Contacts par Statut</h3>
                    <div id="status-chart-container">
                        <!-- Chart visualization goes here -->
                        <p class="text-gray-500 text-center p-4">Chargement des donn√©es...</p>
                    </div>
                </div>

            </div>
            
            <!-- 2. CONTACTS VIEW (Main List) -->
            <div id="contacts-view" class="space-y-6 hidden">
                <h2 class="text-3xl font-extrabold text-gray-900">Gestion des Contacts</h2>
                
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                    <div class="flex space-x-3 w-full sm:w-auto">
                         <button id="add-contact-btn" class="flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                            Ajouter Contact
                        </button>
                         <button class="flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Importer CSV
                        </button>
                    </div>
                   
                    <input type="text" id="contact-search-input" placeholder="Rechercher par nom, statut, email..." class="block w-full sm:w-72 border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Contacts Table -->
                <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                    <div class="overflow-x-auto">
                         <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√©nom(s)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√©l√©phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut (Campagne)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsable</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Contact rows will be dynamically populated -->
                                <tr><td colspan="7" class="text-center text-gray-500 p-4">Chargement des contacts...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 3. TEAM VIEW (Member Management) -->
            <div id="team-view" class="space-y-6 hidden">
                 <h2 class="text-3xl font-extrabold text-gray-900">Gestion de l'√âquipe</h2>

                <!-- Admin Management Section (Admin Only) -->
                <div id="admin-team-management" class="p-6 bg-white rounded-xl shadow-lg space-y-6 hidden border-l-4 border-red-500">
                    <h3 class="text-2xl font-semibold text-red-700">Administration des Membres</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <!-- Add New Member Form -->
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-3">
                            <h4 class="text-lg font-medium text-gray-900">Ajouter un nouveau membre</h4>
                            <input type="text" id="new-member-name" placeholder="Nom du membre" class="block w-full border border-gray-300 rounded-md p-2 text-sm">
                            <select id="new-member-role" class="block w-full border border-gray-300 rounded-md p-2 text-sm">
                                <option value="member">Membre (Par d√©faut)</option>
                                <option value="admin">Administrateur</option>
                            </select>
                            <button id="add-team-member-btn" class="w-full bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition duration-150">G√©n√©rer Cl√© & Ajouter</button>
                        </div>
                         <!-- Member List -->
                        <div class="max-h-96 overflow-y-auto pr-2">
                             <div id="team-list-container">
                                 <p class="text-gray-500 text-center">Chargement des membres...</p>
                             </div>
                        </div>
                     </div>
                </div>

                <!-- Assigned Contacts Section (All Users) -->
                <div class="p-6 bg-white rounded-xl shadow-lg space-y-4 border-l-4 border-blue-500">
                    <div class="flex items-center space-x-4">
                        <h3 id="contacts-assigned-title" class="text-2xl font-semibold text-gray-900">Mes Contacts Assign√©s</h3>
                         <!-- Admin Dropdown for viewing other members' contacts -->
                        <select id="assign-contact-dropdown" class="p-2 border rounded-lg text-sm hidden" data-selected=""></select>
                    </div>
                    
                    <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                        <div class="overflow-x-auto">
                            <div id="contacts-assigned-list">
                                 <!-- Assigned contact table goes here -->
                                <p class="text-gray-500 text-center p-4">Chargement des contacts...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- 4. PROJECTIONS VIEW (Admin Only) -->
            <div id="projections-view" class="space-y-6 hidden">
                <h2 class="text-3xl font-extrabold text-gray-900">Outil de Projection & Simulation</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Current Campaign Data -->
                    <div class="lg:col-span-1 kpi-card space-y-3 border-l-4 border-blue-500">
                        <h3 class="text-xl font-semibold text-gray-900">Donn√©es Actuelles</h3>
                        <div class="flex justify-between border-b pb-1">
                            <span class="text-sm text-gray-500">Total Contacts</span>
                            <span id="current-total-contacts" class="font-medium text-gray-700">0</span>
                        </div>
                        <div class="flex justify-between border-b pb-1">
                            <span class="text-sm text-gray-500">Votes Acquis</span>
                            <span id="current-acquired" class="font-medium text-green-600">0</span>
                        </div>
                        <div class="flex justify-between pb-1">
                            <span class="text-sm text-gray-500">Votes Probables</span>
                            <span id="current-probable" class="font-medium text-yellow-600">0</span>
                        </div>
                    </div>
                    
                    <!-- Simulation Parameters -->
                    <div class="lg:col-span-2 kpi-card space-y-4 border-l-4 border-indigo-500">
                        <h3 class="text-xl font-semibold text-gray-900">Param√®tres de Simulation</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="total-inscrits" class="block text-sm font-medium text-gray-700">Total d'Inscrits (LEC)</label>
                                <input type="number" id="total-inscrits" value="18000" min="100" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            </div>
                             <div>
                                <label for="participation-rate" class="block text-sm font-medium text-gray-700">Taux de Participation (%)</label>
                                <input type="number" id="participation-rate" value="25" min="1" max="100" step="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            </div>
                             <div>
                                <label for="num-listes" class="block text-sm font-medium text-gray-700">Nombre de Listes en Comp√©tition</label>
                                <input type="number" id="num-listes" value="4" min="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            </div>
                             <div>
                                <label for="seats-goal" class="block text-sm font-medium text-gray-700">Si√®ges Vis√©s</label>
                                <input type="number" id="seats-goal" value="1" min="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            </div>
                        </div>
                        <button id="run-projection-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition duration-150">Lancer la Projection</button>
                    </div>
                </div>
                
                <!-- Simulation Results -->
                <div class="kpi-card space-y-3">
                    <h3 class="text-xl font-semibold text-gray-900">R√©sultats de la Simulation</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="p-3 border rounded-lg bg-blue-50">
                            <p class="text-xs text-gray-600">Participation Estim√©e</p>
                            <p id="sim-turnout" class="text-lg font-bold text-blue-800">0</p>
                        </div>
                        <div class="p-3 border rounded-lg bg-red-50">
                            <p class="text-xs text-gray-600">Votes N√©cessaires (Objectif)</p>
                            <p id="sim-required-votes" class="text-lg font-bold text-red-800">0</p>
                        </div>
                        <div class="p-3 border rounded-lg bg-green-50">
                            <p class="text-xs text-gray-600">Votes Projet√©s Actuels</p>
                            <p class="text-lg font-bold text-green-800" id="kpi-projected-votes-sim">0</p>
                            <script>document.getElementById('kpi-projected-votes-sim').textContent = document.getElementById('kpi-projected-votes').textContent;</script>
                        </div>
                         <div class="p-3 border rounded-lg bg-gray-50">
                            <p class="text-xs text-gray-600">Marge vs. Objectif</p>
                            <p id="sim-gap" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                    <p id="sim-status" class="text-center font-semibold text-gray-700 pt-2">Veuillez lancer une projection.</p>
                </div>
                
                <!-- History Chart -->
                <div class="kpi-card">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">√âvolution de la Campagne</h3>
                    <div id="history-chart-container" class="w-full">
                        <p class="text-gray-500 text-center p-4">Chargement de l'historique...</p>
                    </div>
                </div>

            </div>

        </main>
    </div>
    
    <!-- Contact Modal (Hidden by default) -->
    <div id="contact-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900 border-b pb-2">Ajouter/√âditer Contact</h3>
            
            <form id="contact-form" onsubmit="event.preventDefault(); window.saveContact();">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="contact-last-name" class="block text-sm font-medium text-gray-700">Nom*</label>
                        <input type="text" id="contact-last-name" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>
                    <div>
                        <label for="contact-first-name" class="block text-sm font-medium text-gray-700">Pr√©nom*</label>
                        <input type="text" id="contact-first-name" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>
                    <div>
                        <label for="contact-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="contact-email" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>
                    <div>
                        <label for="contact-phone" class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                        <input type="tel" id="contact-phone" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>
                     <div>
                        <label for="contact-status" class="block text-sm font-medium text-gray-700">Statut Campagne</label>
                        <select id="contact-status" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                            <option value="√Ä contacter">√Ä contacter</option>
                            <option value="R√©ticent">R√©ticent</option>
                            <option value="Probable">Probable</option>
                            <option value="Acquis">Acquis</option>
                            <option value="Refus">Refus</option>
                        </select>
                    </div>
                     <div>
                        <label for="contact-responsible" class="block text-sm font-medium text-gray-700">Responsable</label>
                        <select id="contact-responsible" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                            <!-- Options dynamically populated -->
                        </select>
                    </div>
                </div>
            </form>
            
            <div class="flex justify-end space-x-3 pt-4 border-t mt-4">
                <button onclick="window.closeContactModal()" type="button" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                    Annuler
                </button>
                <button onclick="window.deleteContact()" type="button" class="px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                    Supprimer
                </button>
                <button onclick="window.saveContact()" type="submit" class="px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                    Sauvegarder
                </button>
            </div>
        </div>
    </div>
</body>
</html>
